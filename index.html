<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PetCare AI">
    <title>PetCare AI - 반려동물 건강 관리</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Crimson+Pro:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8475593324925808"
         crossorigin="anonymous"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Modern, sophisticated color palette */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --accent: #f59e0b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #06b6d4;
            
            /* Refined neutrals */
            --bg: #0f172a;
            --bg-elevated: #1e293b;
            --bg-card: #1e293b;
            --surface: #334155;
            --text: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            
            /* Typography */
            --font-display: 'Plus Jakarta Sans', -apple-system, sans-serif;
            --font-body: 'Plus Jakarta Sans', -apple-system, sans-serif;
            --font-accent: 'Crimson Pro', serif;
        }
        
        body {
            font-family: var(--font-body);
            background: var(--bg);
            color: var(--text);
            padding-bottom: 90px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Page Container */
        .page-container {
            min-height: calc(100vh - 200px);
        }
        
        /* Ambient background effect */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 30% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
            animation: ambient 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes ambient {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-5%, 5%) rotate(5deg); }
        }
        
        .header {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 24px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        
        .header h1 {
            font-family: var(--font-display);
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .ai-badge {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        .premium-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: #1e293b;
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
        }
        
        /* Ad Styles */
        .ad-banner {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(79, 70, 229, 0.05) 100%);
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-radius: 18px;
            padding: 18px;
            margin-bottom: 24px;
            position: relative;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .ad-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .ad-icon {
            font-size: 36px;
            flex-shrink: 0;
        }
        
        .ad-text {
            flex: 1;
        }
        
        .ad-title {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .ad-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .ad-button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .ad-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        .ad-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ad-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text);
        }
        
        .bottom-ad {
            background: var(--bg-card);
            border-radius: 18px;
            padding: 16px;
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Premium Modal Styles */
        .pricing-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
        }
        
        .pricing-card {
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .pricing-card.featured {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(79, 70, 229, 0.05) 100%);
            transform: scale(1.05);
        }
        
        .pricing-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 16px;
            background: rgba(255, 255, 255, 0.2);
            color: var(--text);
        }
        
        .pricing-badge.premium {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #1e293b;
        }
        
        .pricing-price {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 20px;
            letter-spacing: -0.02em;
        }
        
        .pricing-price span {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .pricing-features {
            text-align: left;
            margin-bottom: 24px;
        }
        
        .feature-item {
            padding: 10px 0;
            font-size: 14px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .feature-item:last-child {
            border-bottom: none;
        }
        
        .feature-item.disabled {
            color: var(--text-muted);
            opacity: 0.5;
        }
        
        .pricing-button {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .pricing-button.primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }
        
        .pricing-button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(99, 102, 241, 0.4);
        }
        
        .pricing-button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }
        
        .premium-benefits {
            background: var(--bg-elevated);
            border-radius: 18px;
            padding: 20px;
        }
        
        .benefit-item {
            display: flex;
            align-items: start;
            gap: 16px;
            padding: 16px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .benefit-item:last-child {
            border-bottom: none;
        }
        
        .benefit-icon {
            font-size: 32px;
            flex-shrink: 0;
        }
        
        .benefit-title {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 4px;
        }
        
        .benefit-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .premium-banner {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.1) 100%);
            border: 2px solid rgba(251, 191, 36, 0.3);
        }
        
        /* Period Toggle */
        .period-tab {
            flex: 1;
            padding: 14px 20px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }
        
        .period-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .period-tab:hover:not(.active) {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .header p {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Search Bar */
        .search-bar {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            color: var(--text);
            font-size: 15px;
            font-family: var(--font-body);
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.2);
        }
        
        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 8px;
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .search-result-item {
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .search-result-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        .search-result-type {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .search-result-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }
        
        .search-result-detail {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .search-highlight {
            background: rgba(251, 191, 36, 0.3);
            color: var(--accent);
            padding: 2px 4px;
            border-radius: 4px;
        }
        
        /* Onboarding */
        .onboarding-step {
            animation: fadeIn 0.4s ease;
        }
        
        .onboarding-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .onboarding-dot.active {
            width: 24px;
            border-radius: 4px;
            background: var(--primary);
        }
        
        /* Statistics Dashboard */
        .stats-summary-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .stat-summary-card {
            background: var(--bg-elevated);
            border-radius: 14px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .stat-summary-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }
        
        .stat-summary-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        
        .stat-summary-value {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .stat-summary-label {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .stats-comparison {
            background: var(--bg-elevated);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .comparison-title, .top-items-title, .insights-title {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        .comparison-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .comparison-item:last-child {
            border-bottom: none;
        }
        
        .comparison-change {
            font-weight: 700;
            font-size: 15px;
        }
        
        .comparison-change.positive {
            color: var(--success);
        }
        
        .comparison-change.negative {
            color: var(--danger);
        }
        
        .stats-top-items, .stats-insights {
            background: var(--bg-elevated);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .top-item, .insight-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .top-item:last-child, .insight-item:last-child {
            margin-bottom: 0;
        }
        
        .insight-item {
            display: flex;
            gap: 12px;
        }
        
        .insight-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        /* Quick Date Buttons */
        .quick-date-btn {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .quick-date-btn:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .quick-date-btn:active {
            transform: scale(0.95);
        }
        
        /* Floating Add Button */
        .floating-add-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .floating-add-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 28px rgba(99, 102, 241, 0.6);
        }
        
        .floating-add-btn:active {
            transform: scale(0.95);
        }
        
        /* FAQ Styles */
        .faq-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .faq-item {
            background: var(--bg-elevated);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .faq-question {
            padding: 16px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .faq-question:hover {
            background: rgba(99, 102, 241, 0.1);
        }
        
        .faq-icon {
            transition: transform 0.3s ease;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .faq-question.active .faq-icon {
            transform: rotate(180deg);
        }
        
        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0 20px;
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-secondary);
        }
        
        .faq-answer.active {
            max-height: 500px;
            padding: 0 20px 16px 20px;
        }
        
        /* Charts */
        .chart-container {
            background: var(--bg-card);
            border-radius: 14px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .chart-title {
            font-weight: 700;
            font-size: 16px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 24px 20px;
            position: relative;
            z-index: 1;
        }
        
        .pet-selector {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 16px 0;
            margin-bottom: 28px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .pet-selector::-webkit-scrollbar {
            display: none;
        }
        
        .pet-card {
            min-width: 130px;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 2px solid transparent;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .pet-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }
        
        .pet-card.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(79, 70, 229, 0.1) 100%);
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.4);
        }
        
        .pet-card:active {
            transform: scale(0.97);
        }
        
        .pet-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin: 0 auto 12px;
            box-shadow: 0 8px 20px rgba(251, 191, 36, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.1);
        }
        
        .pet-name {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 4px;
            letter-spacing: -0.01em;
        }
        
        .pet-info {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .add-pet {
            min-width: 130px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 20px;
            padding: 18px;
            text-align: center;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }
        
        .add-pet:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.5);
        }
        
        .practical-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
            margin-bottom: 28px;
        }
        
        @media (min-width: 640px) {
            .practical-features {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .feature-card {
            background: var(--bg-card);
            border-radius: 18px;
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 2px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .feature-card:hover::before {
            opacity: 1;
        }
        
        .feature-card:hover {
            transform: translateY(-6px);
            border-color: var(--primary);
            box-shadow: 0 12px 40px rgba(99, 102, 241, 0.3);
        }
        
        .feature-card:active {
            transform: scale(0.95);
        }
        
        .feature-icon {
            font-size: 42px;
            margin-bottom: 10px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            position: relative;
            z-index: 1;
        }
        
        .feature-label {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: -0.01em;
            margin-bottom: 4px;
            position: relative;
            z-index: 1;
        }
        
        .feature-sublabel {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
            position: relative;
            z-index: 1;
        }
        
        .section {
            background: var(--bg-card);
            border-radius: 22px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.05);
            animation: fadeInUp 0.6s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .section-header[style*="cursor: pointer"]:hover {
            transform: translateX(4px);
        }
        
        .section-header[style*="cursor: pointer"]:hover .section-title {
            color: var(--primary);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .add-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        .add-btn:active {
            transform: scale(0.95);
        }
        
        .record-item {
            padding: 18px;
            border-left: 4px solid var(--primary);
            background: var(--bg-elevated);
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .record-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }
        
        .record-item.vaccination {
            border-left-color: var(--success);
        }
        
        .record-item.medication {
            border-left-color: var(--warning);
        }
        
        .record-item.hospital {
            border-left-color: var(--danger);
        }
        
        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        
        .record-title {
            font-weight: 600;
            font-size: 16px;
            letter-spacing: -0.01em;
        }
        
        .record-date {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .record-detail {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 6px;
            line-height: 1.5;
        }
        
        .next-date {
            display: inline-block;
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 72px;
            margin-bottom: 20px;
            opacity: 0.6;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: 26px;
            width: 100%;
            max-width: 520px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        @keyframes modalSlideUp {
            from {
                transform: translateY(100px) scale(0.9);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 26px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .close-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text);
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .form-group {
            margin-bottom: 22px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 14px;
            letter-spacing: -0.01em;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            background: var(--bg-elevated);
            color: var(--text);
            transition: all 0.3s ease;
        }
        
        .form-textarea {
            min-height: 110px;
            resize: vertical;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-card);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 26px;
        }
        
        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: -0.01em;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(99, 102, 241, 0.4);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 26px 22px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-value {
            font-size: 42px;
            font-weight: 800;
            line-height: 1;
            letter-spacing: -0.03em;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 8px;
            font-weight: 600;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-around;
            padding: 14px 0 max(14px, env(safe-area-inset-bottom));
            z-index: 100;
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.3);
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-item:hover {
            color: var(--text-secondary);
        }
        
        .nav-icon {
            font-size: 26px;
            margin-bottom: 4px;
            transition: transform 0.3s ease;
        }
        
        .nav-item.active .nav-icon {
            transform: scale(1.1);
        }
        
        .nav-label {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }
        
        .upcoming-alerts {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.2);
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }
        
        .alert-item:last-child {
            border-bottom: none;
        }
        
        .alert-icon {
            font-size: 28px;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: 700;
            margin-bottom: 4px;
            color: #92400e;
        }
        
        .alert-time {
            font-size: 12px;
            opacity: 0.7;
            color: #92400e;
            font-weight: 500;
        }
        
        /* AI Feature Specific Styles */
        .photo-upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 18px;
            padding: 50px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            margin-bottom: 24px;
            background: var(--bg-elevated);
        }
        
        .photo-upload-area:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
            transform: translateY(-4px);
        }
        
        .upload-icon {
            font-size: 56px;
            margin-bottom: 18px;
            opacity: 0.6;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }
        
        .preview-image {
            max-width: 100%;
            border-radius: 18px;
            margin-bottom: 24px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
        }
        
        .analysis-result {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1) 0%, rgba(6, 182, 212, 0.05) 100%);
            border-radius: 18px;
            padding: 24px;
            margin-top: 24px;
            border: 1px solid rgba(6, 182, 212, 0.2);
        }
        
        .analysis-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
            font-weight: 700;
            font-size: 18px;
        }
        
        .severity-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 18px;
            letter-spacing: 0.02em;
        }
        
        .severity-low {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .severity-medium {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .severity-high {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .analysis-section {
            margin-bottom: 18px;
        }
        
        .analysis-section h4 {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .analysis-section p {
            font-size: 15px;
            line-height: 1.7;
            color: var(--text);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 520px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--bg-elevated);
            border-radius: 18px;
            margin-bottom: 18px;
        }
        
        .chat-message {
            margin-bottom: 18px;
            display: flex;
            gap: 12px;
            animation: messageSlide 0.3s ease;
        }
        
        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-message.user {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .message-avatar.ai {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }
        
        .message-avatar.user {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .message-bubble.ai {
            background: var(--bg-card);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .message-bubble.user {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .chat-input-area {
            display: flex;
            gap: 12px;
        }
        
        .chat-input {
            flex: 1;
            padding: 14px 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 28px;
            font-size: 15px;
            font-family: inherit;
            background: var(--bg-elevated);
            color: var(--text);
            transition: all 0.3s ease;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }
        
        .send-btn {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }
        
        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 24px rgba(99, 102, 241, 0.4);
        }
        
        .send-btn:active {
            transform: scale(0.95);
        }
        
        .health-score {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            border-radius: 24px;
            padding: 40px 30px;
            text-align: center;
            margin-bottom: 24px;
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.3);
        }
        
        .score-value {
            font-size: 88px;
            font-weight: 800;
            line-height: 1;
            letter-spacing: -0.04em;
        }
        
        .score-label {
            font-size: 19px;
            opacity: 0.95;
            margin-top: 12px;
            font-weight: 600;
        }
        
        .report-section {
            background: var(--bg-card);
            border-radius: 18px;
            padding: 24px;
            margin-bottom: 18px;
            border-left: 5px solid var(--primary);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }
        
        .report-section h3 {
            font-size: 17px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            letter-spacing: -0.01em;
        }
        
        .report-section ul {
            list-style: none;
            padding: 0;
        }
        
        .report-section li {
            padding: 10px 0;
            font-size: 14px;
            display: flex;
            align-items: start;
            gap: 10px;
            line-height: 1.6;
            color: var(--text-secondary);
        }
        
        .report-section li:before {
            content: "•";
            color: var(--primary);
            font-weight: bold;
            font-size: 20px;
            line-height: 1.4;
        }
        
        .disclaimer {
            background: rgba(245, 158, 11, 0.15);
            border-radius: 14px;
            padding: 18px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 24px;
            text-align: center;
            line-height: 1.6;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .file-input {
            display: none;
        }
        
        /* Search Mode Tabs */
        .search-mode-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            background: var(--bg-elevated);
            padding: 6px;
            border-radius: 14px;
        }
        
        .search-tab {
            flex: 1;
            padding: 12px 16px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }
        
        .search-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .search-tab:hover:not(.active) {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* Hospital Search Styles */
        .hospital-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .hospital-card:hover {
            transform: translateX(4px);
            border-color: var(--primary);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.2);
        }
        
        .hospital-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        
        .hospital-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
            letter-spacing: -0.01em;
        }
        
        .hospital-distance {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .hospital-info {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .hospital-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .status-open {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }
        
        .status-closed {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }
        
        .hospital-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .action-btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: var(--bg-elevated);
            color: var(--text);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .action-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .no-results-icon {
            font-size: 56px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        /* Filter Tabs */
        .filter-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        
        .filter-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .filter-tab {
            padding: 10px 20px;
            background: var(--bg-card);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }
        
        .filter-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .filter-tab:hover:not(.active) {
            border-color: var(--primary);
            color: var(--text);
        }
        
        /* Settings Items */
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 12px;
            margin-bottom: 12px;
        }
        
        .settings-button {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px;
            background: var(--bg-elevated);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text);
            text-align: left;
            font-family: inherit;
        }
        
        .settings-button:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
            transform: translateX(4px);
        }
        
        .settings-button.danger {
            border-color: var(--danger);
        }
        
        .settings-button.danger:hover {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }
        
        .settings-button span {
            font-size: 28px;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.2);
            transition: 0.3s;
            border-radius: 28px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .pet-manage-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 12px;
            margin-bottom: 12px;
        }
        
        .pet-manage-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            flex-shrink: 0;
        }
        
        .pet-manage-info {
            flex: 1;
        }
        
        .pet-manage-name {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .pet-manage-details {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .pet-manage-actions {
            display: flex;
            gap: 8px;
        }
        
        .icon-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-button:hover {
            background: var(--primary);
            color: white;
        }
        
        .icon-button.danger:hover {
            background: var(--danger);
        }
        
        /* Photo Gallery */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .photo-item {
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .photo-item:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-date {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        
        /* Meal Tracker */
        .meal-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .summary-item {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        
        .summary-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .meal-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        
        .meal-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .meal-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .meal-info {
            flex: 1;
        }
        
        .meal-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }
        
        .meal-details {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .meal-time {
            font-size: 12px;
            color: var(--text-muted);
            text-align: right;
        }
        
        /* Family Share */
        .family-member-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--bg-elevated);
            border-radius: 12px;
            margin-bottom: 12px;
        }
        
        .member-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .member-info {
            flex: 1;
        }
        
        .member-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }
        
        .member-role {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .info-banner {
            animation: fadeIn 0.5s ease;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-elevated);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>
            🐾 펫케어
            <span class="premium-badge" id="premiumBadge" style="display: none;">PRO</span>
        </h1>
        <p id="headerSubtitle">반려동물의 건강을 펫케어가 관리해드려요</p>
        
        <!-- Global Search Bar -->
        <div class="search-bar" style="margin-top: 16px; position: relative;">
            <input type="text" 
                   id="globalSearch" 
                   placeholder="🔍 기록 검색... (이름, 메모, 날짜)" 
                   class="search-input"
                   onkeyup="handleGlobalSearch(event)"
                   onfocus="showSearchResults()"
                   onblur="hideSearchResultsDelayed()">
            <div id="searchResultsContainer" class="search-results" style="display: none;"></div>
        </div>
    </div>
    
    <!-- Home Page -->
    <div class="page-container" id="homePage">
        <div class="container">
        <!-- Pet Selector -->
        <div class="pet-selector" id="petSelector">
            <div class="add-pet" onclick="openAddPetModal()">+</div>
        </div>
        
        <!-- Ad Banner (Free Version) -->
        <div class="ad-banner" id="adBanner" style="display: none;">
            <div class="ad-content">
                <div class="ad-icon">✨</div>
                <div class="ad-text">
                    <div class="ad-title">펫케어 AI Pro로 업그레이드</div>
                    <div class="ad-subtitle">광고 제거 · 무제한 반려동물 · 무제한 가족 공유</div>
                </div>
                <button class="ad-button" onclick="openPremiumModal()">업그레이드</button>
            </div>
            <button class="ad-close" onclick="hideAd()" title="닫기">×</button>
        </div>
        
        <!-- Bottom Ad (Free Version) -->
        <div class="bottom-ad" id="bottomAd" style="display: none;">
            <div style="font-size: 10px; color: rgba(255,255,255,0.5); margin-bottom: 8px; text-align: center;">광고</div>
            <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer;" onclick="openPremiumModal()">
                <div style="font-size: 16px; font-weight: 700; margin-bottom: 8px;">🎯 반려동물 보험</div>
                <div style="font-size: 13px; color: var(--text-secondary);">월 9,900원부터 · 의료비 최대 90% 보장</div>
            </div>
        </div>
        
        <!-- Google AdSense Banner (무료 사용자만 표시, 프리미엄은 숨김) -->
        <div class="bottom-ad" id="googleAdBanner" style="display: none; margin-bottom: 24px;">
            <div style="font-size: 10px; color: rgba(255,255,255,0.5); margin-bottom: 8px; text-align: center;">광고</div>
            <ins class="adsbygoogle"
                 style="display:inline-block;width:100%;max-height:100px;overflow:hidden;"
                 data-ad-client="ca-pub-8475593324925808"
                 data-ad-format="horizontal"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>
        
        <!-- Practical Features -->
        <div class="practical-features" id="practicalFeatures" style="display: none;">
            <div class="feature-card" onclick="switchTab('album')">
                <div class="feature-icon">📸</div>
                <div class="feature-label">사진 앨범</div>
                <div class="feature-sublabel">추억 기록</div>
            </div>
            <div class="feature-card" onclick="openFamilyShare()">
                <div class="feature-icon">👨‍👩‍👧‍👦</div>
                <div class="feature-label">가족 공유</div>
                <div class="feature-sublabel">함께 관리</div>
            </div>
            <div class="feature-card" onclick="switchTab('meal')">
                <div class="feature-icon">🍖</div>
                <div class="feature-label">식단 관리</div>
                <div class="feature-sublabel">급여 기록</div>
            </div>
            <div class="feature-card" onclick="openAddWeightModal()">
                <div class="feature-icon">⚖️</div>
                <div class="feature-label">체중 기록</div>
                <div class="feature-sublabel" id="currentWeight">기록하기</div>
            </div>
        </div>
        
        <!-- Monthly Stats Summary -->
        <div class="section" id="monthlyStatsSection" style="display: none;">
            <div class="section-header" style="cursor: pointer;" onclick="openStatsModal()">
                <div class="section-title">📊 이번 달 통계</div>
                <button class="add-btn" onclick="event.stopPropagation(); openStatsModal()">자세히 보기</button>
            </div>
            <div class="stats-summary-grid">
                <div class="stat-summary-card">
                    <div class="stat-summary-icon">💉</div>
                    <div class="stat-summary-value" id="monthVaccinations">0</div>
                    <div class="stat-summary-label">예방접종</div>
                </div>
                <div class="stat-summary-card">
                    <div class="stat-summary-icon">🍖</div>
                    <div class="stat-summary-value" id="monthMeals">0</div>
                    <div class="stat-summary-label">급여 횟수</div>
                </div>
                <div class="stat-summary-card">
                    <div class="stat-summary-icon">🏥</div>
                    <div class="stat-summary-value" id="monthHospitals">0</div>
                    <div class="stat-summary-label">병원 방문</div>
                </div>
                <div class="stat-summary-card">
                    <div class="stat-summary-icon">💰</div>
                    <div class="stat-summary-value" id="monthCost">0원</div>
                    <div class="stat-summary-label">의료비</div>
                </div>
            </div>
        </div>
        
        <!-- Upcoming Alerts -->
        <div class="upcoming-alerts" id="upcomingAlerts" style="display: none;">
            <div style="font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 10px; color: #92400e;">
                <span>⏰</span>
                <span>다가오는 일정</span>
            </div>
            <div id="alertsList"></div>
        </div>
        
        <!-- Stats -->
        <div class="stats-grid" id="statsGrid" style="display: none;">
            <div class="stat-card" onclick="viewRecordsByType('vaccination')" style="cursor: pointer;">
                <div class="stat-value" id="vaccinationCount">0</div>
                <div class="stat-label">예방접종 기록</div>
            </div>
            <div class="stat-card" onclick="viewRecordsByType('medication')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); cursor: pointer;">
                <div class="stat-value" id="medicationCount">0</div>
                <div class="stat-label">투약 중</div>
            </div>
        </div>
        
        <!-- Vaccinations Section -->
        <div class="section" id="vaccinationsSection" style="display: none;">
            <div class="section-header" style="cursor: pointer;" onclick="viewRecordsByType('vaccination')">
                <div class="section-title">
                    💉 <span>예방접종</span>
                </div>
                <button class="add-btn" onclick="event.stopPropagation(); openAddRecordModal('vaccination')">+ 추가</button>
            </div>
            <div id="vaccinationsList"></div>
        </div>
        
        <!-- Medications Section -->
        <div class="section" id="medicationsSection" style="display: none;">
            <div class="section-header" style="cursor: pointer;" onclick="viewRecordsByType('medication')">
                <div class="section-title">
                    💊 <span>투약 일정</span>
                </div>
                <button class="add-btn" onclick="event.stopPropagation(); openAddRecordModal('medication')">+ 추가</button>
            </div>
            <div id="medicationsList"></div>
        </div>
        
        <!-- Hospital Records Section -->
        <div class="section" id="hospitalSection" style="display: none;">
            <div class="section-header" style="cursor: pointer;" onclick="viewRecordsByType('hospital')">
                <div class="section-title">
                    🏥 <span>병원 기록</span>
                </div>
                <button class="add-btn" onclick="event.stopPropagation(); openAddRecordModal('hospital')">+ 추가</button>
            </div>
            <div id="hospitalList"></div>
        </div>
        
        <!-- Empty State -->
        <div class="section" id="emptyState">
            <div class="empty-state">
                <div class="empty-state-icon">🐕</div>
                <div style="font-size: 20px; font-weight: 700; margin-bottom: 12px; letter-spacing: -0.02em;">반려동물을 추가해주세요</div>
                <div style="font-size: 15px; line-height: 1.6;">+ 버튼을 눌러 첫 번째 반려동물을 등록하고<br>AI 건강 분석을 시작하세요!</div>
            </div>
        </div>
    </div>
    </div>
    
    <!-- Album Page -->
    <div class="page-container" id="albumPage" style="display: none;">
        <div class="container">
            <div style="margin-bottom: 24px;">
                <h2 style="font-size: 26px; font-weight: 800; letter-spacing: -0.02em; margin-bottom: 8px;">📸 사진 앨범</h2>
                <p style="color: var(--text-secondary); font-size: 14px;">소중한 추억을 기록하세요</p>
            </div>
            
            <!-- Pet Selector Dropdown -->
            <div style="margin-bottom: 20px;">
                <select class="form-select" id="albumPetSelect" onchange="switchPetFromPage('album', this.value)" style="max-width: 300px;">
                    <option value="">반려동물 선택...</option>
                </select>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="font-size: 14px; color: var(--text-secondary);">
                    <span id="photoCountPage">0</span>장의 추억
                </div>
                <button class="add-btn" onclick="document.getElementById('photoUploadPage').click()">+ 사진 추가</button>
            </div>
            <input type="file" id="photoUploadPage" accept="image/*" multiple style="display: none;" onchange="handlePhotoAddPage(event)">
            
            <div id="photoGridPage" class="photo-grid"></div>
            
            <div id="emptyPhotosPage" class="empty-state">
                <div class="empty-state-icon">📷</div>
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">아직 사진이 없어요</div>
                <div style="font-size: 14px;">소중한 순간을 기록해보세요!</div>
            </div>
        </div>
    </div>
    
    <!-- Meal Page -->
    <div class="page-container" id="mealPage" style="display: none;">
        <div class="container">
            <div style="margin-bottom: 24px;">
                <h2 style="font-size: 26px; font-weight: 800; letter-spacing: -0.02em; margin-bottom: 8px;">🍖 식단 관리</h2>
                <p style="color: var(--text-secondary); font-size: 14px;">오늘 무엇을 먹였나요?</p>
            </div>
            
            <!-- Pet Selector Dropdown -->
            <div style="margin-bottom: 20px;">
                <select class="form-select" id="mealPetSelect" onchange="switchPetFromPage('meal', this.value)" style="max-width: 300px;">
                    <option value="">반려동물 선택...</option>
                </select>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="font-size: 14px; color: var(--text-secondary);">
                    오늘의 급여
                </div>
                <button class="add-btn" onclick="openAddMealModalPage()">+ 급여 기록</button>
            </div>
            
            <!-- Today's Meals Summary -->
            <div class="meal-summary">
                <div class="summary-item">
                    <div class="summary-label">오늘 급여</div>
                    <div class="summary-value"><span id="todayMealCountPage">0</span>회</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">총 칼로리</div>
                    <div class="summary-value"><span id="todayCaloriesPage">0</span>kcal</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">급여량</div>
                    <div class="summary-value"><span id="todayAmountPage">0</span>g</div>
                </div>
            </div>
            
            <!-- Filter Tabs -->
            <div class="filter-tabs" style="margin-bottom: 20px;">
                <div class="filter-tab active" onclick="filterMealsPage('all')">전체</div>
                <div class="filter-tab" onclick="filterMealsPage('today')">오늘</div>
                <div class="filter-tab" onclick="filterMealsPage('week')">이번 주</div>
            </div>
            
            <div id="mealsListPage"></div>
            
            <div id="emptyMealsPage" class="empty-state">
                <div class="empty-state-icon">🍽️</div>
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">급여 기록이 없어요</div>
                <div style="font-size: 14px;">식사와 간식을 기록해보세요!</div>
            </div>
        </div>
    </div>
    
    <!-- Records Page -->
    <div class="page-container" id="recordsPage" style="display: none;">
        <div class="container">
        <div style="margin-bottom: 24px;">
            <h2 style="font-size: 26px; font-weight: 800; letter-spacing: -0.02em; margin-bottom: 8px;">📋 전체 기록</h2>
            <p style="color: var(--text-secondary); font-size: 14px;">모든 반려동물의 건강 기록을 한눈에 확인하세요</p>
        </div>
        
        <!-- Filter Tabs -->
        <div class="filter-tabs" style="display: flex; gap: 10px; margin-bottom: 24px; overflow-x: auto;">
            <div class="filter-tab active" onclick="filterRecords('all')">전체</div>
            <div class="filter-tab" onclick="filterRecords('vaccination')">예방접종</div>
            <div class="filter-tab" onclick="filterRecords('medication')">투약</div>
            <div class="filter-tab" onclick="filterRecords('hospital')">병원</div>
        </div>
        
        <div id="allRecordsList"></div>
    </div>
    </div>
    
    <!-- Records Detail Page (for specific type) -->
    <div class="page-container" id="recordsDetailPage" style="display: none;">
        <div class="container">
            <div style="margin-bottom: 24px;">
                <button onclick="goBackFromDetail()" style="background: rgba(255,255,255,0.1); border: none; color: var(--text); padding: 8px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                    <span>←</span>
                    <span>뒤로</span>
                </button>
                <h2 style="font-size: 26px; font-weight: 800; letter-spacing: -0.02em; margin-bottom: 8px;" id="recordsDetailTitle">기록</h2>
                <p style="color: var(--text-secondary); font-size: 14px;" id="recordsDetailSubtitle"></p>
            </div>
            
            <div id="recordsDetailList"></div>
            
            <!-- Floating Add Button -->
            <button class="floating-add-btn" id="recordsDetailAddBtn" onclick="openAddFromDetail()" title="기록 추가">
                <span style="font-size: 24px;">+</span>
            </button>
        </div>
    </div>
    
    <!-- Settings Page -->
    <div class="page-container" id="settingsPage" style="display: none;">
        <div class="container">
        <div style="margin-bottom: 24px;">
            <h2 style="font-size: 26px; font-weight: 800; letter-spacing: -0.02em; margin-bottom: 8px;">⚙️ 설정</h2>
            <p style="color: var(--text-secondary); font-size: 14px;">앱 설정 및 데이터 관리</p>
        </div>
        
        <!-- Premium Status (Free users) -->
        <div class="section premium-banner" id="premiumBannerSettings" style="display: none;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="font-size: 48px;">✨</div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 18px; margin-bottom: 4px;">펫케어 AI Pro</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">광고 없이 모든 기능을 무제한으로</div>
                </div>
                <button class="add-btn" onclick="openPremiumModal()">업그레이드</button>
            </div>
        </div>
        
        <!-- Premium Status (Pro users) -->
        <div class="section" id="premiumStatusSettings" style="display: none; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white;">
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="font-size: 48px;">👑</div>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 18px; margin-bottom: 4px;">펫케어 AI Pro 구독 중</div>
                    <div style="font-size: 14px; opacity: 0.9;">다음 결제일: <span id="nextBillingDate"></span></div>
                </div>
            </div>
            <button class="settings-button" onclick="cancelSubscription()" style="background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.3); color: white; margin-top: 12px;">
                <span>❌</span>
                <div>
                    <div style="font-weight: 600;">구독 취소</div>
                    <div style="font-size: 12px; opacity: 0.8;">언제든 다시 구독할 수 있습니다</div>
                </div>
            </button>
        </div>
        
        <!-- Settings Sections -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">🐾 반려동물 관리</div>
            </div>
            <div id="petManagementList"></div>
        </div>
        
        <div class="section">
            <div class="section-header">
                <div class="section-title">🔔 알림 설정</div>
            </div>
            <div class="settings-item">
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px;">예방접종 알림</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">예정된 예방접종 3일 전 알림</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="vaccinationNotif" onchange="toggleNotifications('vaccination', this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="settings-item">
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px;">투약 알림</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">매일 투약 시간 알림</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="medicationNotif" onchange="toggleNotifications('medication', this.checked)">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div id="notificationPermissionWarning" style="display: none; margin-top: 12px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
                ⚠️ 알림을 받으려면 브라우저 알림 권한을 허용해주세요.
                <button class="btn btn-secondary" onclick="requestNotificationPermission()" style="margin-top: 8px; width: 100%; padding: 8px;">
                    권한 요청하기
                </button>
            </div>
        </div>
        
        <!-- Trash Bin Section -->
        <div class="section">
            <div class="section-header" style="cursor: pointer;" onclick="openTrashModal()">
                <div class="section-title">🗑️ 휴지통</div>
            </div>
            <div onclick="openTrashModal()" style="cursor: pointer; padding: 16px; background: var(--bg-elevated); border-radius: 12px; display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px;">삭제된 반려동물</div>
                    <div style="font-size: 13px; color: var(--text-secondary);" id="trashCount">0마리 (30일 후 자동 삭제)</div>
                </div>
                <span style="color: var(--text-secondary); font-size: 18px;">→</span>
            </div>
        </div>
        
        <div class="section">
            <div class="section-header">
                <div class="section-title">📊 데이터 관리</div>
            </div>
            <button class="settings-button" onclick="openTrashModal()">
                <span>🗑️</span>
                <div>
                    <div style="font-weight: 600;">휴지통</div>
                    <div style="font-size: 12px; color: var(--text-secondary);" id="trashCountText">삭제된 항목 0개</div>
                </div>
            </button>
            <button class="settings-button" onclick="exportData()">
                <span>📤</span>
                <div>
                    <div style="font-weight: 600;">데이터 내보내기</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">모든 기록을 JSON 파일로 저장</div>
                </div>
            </button>
            <button class="settings-button" onclick="document.getElementById('importFile').click()">
                <span>📥</span>
                <div>
                    <div style="font-weight: 600;">데이터 가져오기</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">이전에 저장한 데이터 복원</div>
                </div>
            </button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
        </div>
        
        <div class="section">
            <div class="section-header">
                <div class="section-title">ℹ️ 앱 정보</div>
            </div>
            <div class="settings-item">
                <div>
                    <div style="font-weight: 600; margin-bottom: 4px;">버전</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">PetCare v1.0.0</div>
                </div>
            </div>
            <button class="settings-button" onclick="openAddWeightModal()">
                <span>⚖️</span>
                <div>
                    <div style="font-weight: 600;">체중 기록</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">체중 변화를 추적하세요</div>
                </div>
            </button>
            <button class="settings-button" onclick="openStatsModal()">
                <span>📊</span>
                <div>
                    <div style="font-weight: 600;">통계 & 인사이트</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">건강 데이터 분석</div>
                </div>
            </button>
            <button class="settings-button" onclick="openFAQModal()">
                <span>❓</span>
                <div>
                    <div style="font-weight: 600;">자주 묻는 질문 (FAQ)</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">궁금한 점을 빠르게 해결하세요</div>
                </div>
            </button>
            <button class="settings-button" onclick="openSupportModal()">
                <span>💬</span>
                <div>
                    <div style="font-weight: 600;">1:1 문의</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">직접 문의하기</div>
                </div>
            </button>
        </div>
        
        <div class="section" style="border: 2px solid var(--danger);">
            <div class="section-header">
                <div class="section-title" style="color: var(--danger);">⚠️ 위험 구역</div>
            </div>
            <button class="settings-button danger" onclick="confirmDeleteAllData()">
                <span>🗑️</span>
                <div>
                    <div style="font-weight: 600;">모든 데이터 삭제</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">모든 반려동물과 기록이 영구 삭제됩니다</div>
                </div>
            </button>
        </div>
    </div>
    </div>
    
    <!-- Modals (same structure as before) -->
    <div class="modal" id="addPetModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">반려동물 추가</div>
                <button class="close-btn" onclick="closeModal('addPetModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="addPetForm">
                    <div class="form-group">
                        <label class="form-label">이름 *</label>
                        <input type="text" class="form-input" id="petName" required placeholder="반려동물 이름">
                    </div>
                    <div class="form-group">
                        <label class="form-label">종류 *</label>
                        <select class="form-select" id="petType" required>
                            <option value="">선택하세요</option>
                            <option value="강아지">강아지</option>
                            <option value="고양이">고양이</option>
                            <option value="기타">기타</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">품종</label>
                        <input type="text" class="form-input" id="petBreed" placeholder="예: 골든 리트리버">
                    </div>
                    <div class="form-group">
                        <label class="form-label">생일</label>
                        <input type="date" class="form-input" id="petBirthday">
                    </div>
                    <div class="form-group">
                        <label class="form-label">체중 (kg)</label>
                        <input type="number" step="0.1" class="form-input" id="petWeight" placeholder="0.0">
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addPetModal')">취소</button>
                        <button type="submit" class="btn btn-primary">추가하기</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal" id="addRecordModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="recordModalTitle">기록 추가</div>
                <button class="close-btn" onclick="closeModal('addRecordModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="addRecordForm">
                    <div class="form-group">
                        <label class="form-label" id="recordNameLabel">제목 *</label>
                        <input type="text" class="form-input" id="recordName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">날짜 *</label>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <button type="button" class="quick-date-btn" onclick="setQuickDate('today')">오늘</button>
                            <button type="button" class="quick-date-btn" onclick="setQuickDate('yesterday')">어제</button>
                            <button type="button" class="quick-date-btn" onclick="setQuickDate('week')">일주일 전</button>
                        </div>
                        <input type="date" class="form-input" id="recordDate" required>
                    </div>
                    <div class="form-group" id="nextDateGroup" style="display: none;">
                        <label class="form-label">다음 예정일</label>
                        <input type="date" class="form-input" id="recordNextDate">
                    </div>
                    <div class="form-group" id="frequencyGroup" style="display: none;">
                        <label class="form-label">복용 주기</label>
                        <select class="form-select" id="recordFrequency">
                            <option value="매일">매일</option>
                            <option value="격일">격일</option>
                            <option value="주 1회">주 1회</option>
                            <option value="월 1회">월 1회</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">메모</label>
                        <textarea class="form-textarea" id="recordNotes" placeholder="추가 정보를 입력하세요"></textarea>
                    </div>
                    <div class="form-group" id="costGroup" style="display: none;">
                        <label class="form-label">비용 (원)</label>
                        <input type="number" class="form-input" id="recordCost" placeholder="0">
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addRecordModal')">취소</button>
                        <button type="submit" class="btn btn-primary">저장하기</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal" id="photoAnalysisModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">📸 AI 사진 분석</div>
                <button class="close-btn" onclick="closeModal('photoAnalysisModal')">×</button>
            </div>
            <div class="modal-body">
                <input type="file" id="photoInput" class="file-input" accept="image/*" onchange="handlePhotoUpload(event)">
                
                <div id="uploadArea" class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                    <div class="upload-icon">📷</div>
                    <div style="font-weight: 700; margin-bottom: 10px; font-size: 16px;">사진을 업로드하세요</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">
                        반려동물의 피부, 눈, 귀 등을 촬영하여<br>AI가 건강 상태를 분석해드립니다
                    </div>
                </div>
                
                <img id="previewImage" class="preview-image" style="display: none;">
                
                <div id="analysisLoading" style="display: none; text-align: center; padding: 50px 0;">
                    <div class="loading-spinner" style="width: 48px; height: 48px; border-width: 4px; margin: 0 auto 24px;"></div>
                    <div style="font-weight: 700; font-size: 16px;">AI가 사진을 분석하고 있어요...</div>
                    <div style="font-size: 14px; color: var(--text-secondary); margin-top: 10px;">잠시만 기다려주세요</div>
                </div>
                
                <div id="analysisResult" style="display: none;"></div>
                
                <div class="disclaimer" style="display: none;" id="photoDisclaimer">
                    ⚠️ 이 분석은 참고용이며 수의사 진료를 대체할 수 없습니다. 심각한 증상이 의심되면 즉시 동물병원을 방문하세요.
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="symptomChatModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">💬 AI 증상 상담</div>
                <button class="close-btn" onclick="closeModal('symptomChatModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message">
                            <div class="message-avatar ai">🤖</div>
                            <div class="message-bubble ai">
                                안녕하세요! 반려동물의 증상을 알려주시면 도움을 드리겠습니다. 어떤 증상이 있나요?
                            </div>
                        </div>
                    </div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chatInput" placeholder="증상을 입력하세요..." onkeypress="handleChatKeypress(event)">
                        <button class="send-btn" onclick="sendChatMessage()">➤</button>
                    </div>
                </div>
                <div class="disclaimer" style="margin-top: 18px;">
                    ⚠️ AI 상담은 참고용이며 수의사 진료를 대체할 수 없습니다.
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="healthReportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">📊 AI 건강 리포트</div>
                <button class="close-btn" onclick="closeModal('healthReportModal')">×</button>
            </div>
            <div class="modal-body" id="reportContent">
                <div style="text-align: center; padding: 50px 0;">
                    <div class="loading-spinner" style="width: 48px; height: 48px; border-width: 4px; margin: 0 auto 24px;"></div>
                    <div style="font-weight: 700; font-size: 16px;">건강 리포트 생성 중...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Hospital Search Modal -->
    <div class="modal" id="hospitalSearchModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">🏥 동물병원 찾기</div>
                <button class="close-btn" onclick="closeModal('hospitalSearchModal')">×</button>
            </div>
            <div class="modal-body">
                <!-- Search Mode Toggle -->
                <div class="search-mode-tabs">
                    <div class="search-tab active" id="nearbyTab" onclick="switchSearchMode('nearby')">
                        📍 내 주변
                    </div>
                    <div class="search-tab" id="regionTab" onclick="switchSearchMode('region')">
                        🗺️ 지역 선택
                    </div>
                </div>
                
                <!-- Nearby Search Mode -->
                <div id="nearbySearchMode">
                    <div id="locationStatus" style="text-align: center; padding: 20px 0;">
                        <div class="loading-spinner" style="width: 48px; height: 48px; border-width: 4px; margin: 0 auto 24px;"></div>
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">위치를 확인하고 있어요...</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">잠시만 기다려주세요</div>
                    </div>
                    
                    <div id="nearbyResults" style="display: none;">
                        <div style="margin-bottom: 20px;">
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">
                                📍 <span id="userLocation"></span>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="searchQuery" class="form-input" placeholder="병원 이름 검색..." style="flex: 1;" onkeyup="searchHospitals()">
                                <select id="distanceFilter" class="form-select" style="width: 120px;" onchange="filterByDistance()">
                                    <option value="10">10km 이내</option>
                                    <option value="5">5km 이내</option>
                                    <option value="3">3km 이내</option>
                                    <option value="1">1km 이내</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="hospitalsList"></div>
                    </div>
                </div>
                
                <!-- Region Search Mode -->
                <div id="regionSearchMode" style="display: none;">
                    <div style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label class="form-label">시/도</label>
                            <select class="form-select" id="sidoSelect" onchange="updateSigungu()">
                                <option value="">선택하세요</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">시/군/구</label>
                            <select class="form-select" id="sigunguSelect" onchange="updateDong()">
                                <option value="">시/도를 먼저 선택하세요</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">읍/면/동</label>
                            <select class="form-select" id="dongSelect" onchange="searchByRegion()">
                                <option value="">시/군/구를 먼저 선택하세요</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="regionSearchQuery" class="form-input" placeholder="병원 이름 검색..." style="flex: 1;" onkeyup="searchByRegion()">
                        </div>
                    </div>
                    
                    <div id="regionHospitalsList"></div>
                </div>
                
                <div class="disclaimer" style="margin-top: 20px;">
                    ℹ️ 위치 정보는 병원 검색에만 사용되며 저장되지 않습니다.
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Gallery Modal -->
    <div class="modal" id="photoGalleryModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">📸 사진 앨범</div>
                <button class="close-btn" onclick="closeModal('photoGalleryModal')">×</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: var(--text-secondary);">
                        <span id="photoCount">0</span>장의 추억
                    </div>
                    <button class="add-btn" onclick="document.getElementById('photoUpload').click()">+ 사진 추가</button>
                </div>
                <input type="file" id="photoUpload" accept="image/*" multiple style="display: none;" onchange="handlePhotoAdd(event)">
                
                <div id="photoGrid" class="photo-grid"></div>
                
                <div id="emptyPhotos" class="empty-state">
                    <div class="empty-state-icon">📷</div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">아직 사진이 없어요</div>
                    <div style="font-size: 14px;">소중한 순간을 기록해보세요!</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Photo Detail Modal -->
    <div class="modal" id="photoDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">사진 상세</div>
                <button class="close-btn" onclick="closeModal('photoDetailModal')">×</button>
            </div>
            <div class="modal-body">
                <img id="photoDetailImage" style="width: 100%; border-radius: 12px; margin-bottom: 16px;">
                <div id="photoDetailDate" style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;"></div>
                <div id="photoDetailMemo" style="font-size: 15px; line-height: 1.6; padding: 16px; background: var(--bg-elevated); border-radius: 12px; margin-bottom: 16px;"></div>
                <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                    <button class="btn btn-primary" onclick="sharePhoto()" style="flex: 1;">
                        📤 공유하기
                    </button>
                    <button class="btn btn-secondary" onclick="deletePhoto()" style="flex: 1;">
                        🗑️ 삭제
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Family Share Modal -->
    <div class="modal" id="familyShareModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">👨‍👩‍👧‍👦 가족 공유</div>
                <button class="close-btn" onclick="closeModal('familyShareModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="info-banner" style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(79, 70, 229, 0.05) 100%); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 4px;">가족과 함께 관리하세요</div>
                    <div style="font-size: 13px; color: var(--text-secondary);">초대 링크로 가족 구성원을 추가하고 함께 반려동물을 돌보세요</div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <label class="form-label">초대 링크</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-input" id="inviteLink" readonly value="https://petcare.ai/invite/ABC123" style="flex: 1;">
                        <button class="add-btn" onclick="copyInviteLink()">복사</button>
                    </div>
                </div>
                
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div class="form-label" style="margin: 0;">가족 구성원 (<span id="familyMemberCount">1</span>명)</div>
                    </div>
                    
                    <div id="familyMembersList"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Meal Tracker Modal -->
    <div class="modal" id="mealTrackerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">🍖 식단 관리</div>
                <button class="close-btn" onclick="closeModal('mealTrackerModal')">×</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div style="font-size: 14px; color: var(--text-secondary);">
                        오늘의 급여
                    </div>
                    <button class="add-btn" onclick="openAddMealModal()">+ 급여 기록</button>
                </div>
                
                <!-- Today's Meals Summary -->
                <div class="meal-summary">
                    <div class="summary-item">
                        <div class="summary-label">오늘 급여</div>
                        <div class="summary-value"><span id="todayMealCount">0</span>회</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">총 칼로리</div>
                        <div class="summary-value"><span id="todayCalories">0</span>kcal</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">급여량</div>
                        <div class="summary-value"><span id="todayAmount">0</span>g</div>
                    </div>
                </div>
                
                <!-- Filter Tabs -->
                <div class="filter-tabs" style="margin-bottom: 20px;">
                    <div class="filter-tab active" onclick="filterMeals('all')">전체</div>
                    <div class="filter-tab" onclick="filterMeals('today')">오늘</div>
                    <div class="filter-tab" onclick="filterMeals('week')">이번 주</div>
                </div>
                
                <div id="mealsList"></div>
                
                <div id="emptyMeals" class="empty-state">
                    <div class="empty-state-icon">🍽️</div>
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">급여 기록이 없어요</div>
                    <div style="font-size: 14px;">식사와 간식을 기록해보세요!</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Meal Modal -->
    <div class="modal" id="addMealModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">급여 추가</div>
                <button class="close-btn" onclick="closeModal('addMealModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="addMealForm">
                    <div class="form-group">
                        <label class="form-label">종류 *</label>
                        <select class="form-select" id="mealType" required>
                            <option value="사료">사료</option>
                            <option value="간식">간식</option>
                            <option value="습식">습식</option>
                            <option value="수제">수제 식단</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">제품명</label>
                        <input type="text" class="form-input" id="mealName" placeholder="예: 로얄캐닌 골든리트리버">
                    </div>
                    <div class="form-group">
                        <label class="form-label">급여량 (g)</label>
                        <input type="number" class="form-input" id="mealAmount" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">칼로리 (kcal)</label>
                        <input type="number" class="form-input" id="mealCalories" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">시간 *</label>
                        <input type="datetime-local" class="form-input" id="mealTime" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">메모</label>
                        <textarea class="form-textarea" id="mealNotes" placeholder="예: 잘 먹었어요"></textarea>
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('addMealModal')">취소</button>
                        <button type="submit" class="btn btn-primary">저장</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Premium Upgrade Modal -->
    <div class="modal" id="premiumModal">
        <div class="modal-content">
            <div class="modal-header" style="border-bottom: none;">
                <div style="width: 100%; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 12px;">✨</div>
                    <div class="modal-title" style="font-size: 26px; margin-bottom: 8px;">펫케어 AI Pro</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">프리미엄으로 더 많은 기능을 누리세요</div>
                </div>
                <button class="close-btn" onclick="closeModal('premiumModal')" style="position: absolute; top: 20px; right: 20px;">×</button>
            </div>
            <div class="modal-body">
                <!-- Subscription Period Toggle -->
                <div style="display: flex; gap: 12px; margin-bottom: 28px; background: var(--bg-elevated); padding: 6px; border-radius: 14px;">
                    <div class="period-tab active" id="monthlyTab" onclick="switchPeriod('monthly')">
                        월간
                    </div>
                    <div class="period-tab" id="yearlyTab" onclick="switchPeriod('yearly')">
                        <div>연간</div>
                        <div style="font-size: 11px; color: #10b981; font-weight: 800;">17% 할인</div>
                    </div>
                </div>
                
                <!-- Pricing -->
                <div class="pricing-cards">
                    <div class="pricing-card">
                        <div class="pricing-badge">무료</div>
                        <div class="pricing-price">₩0<span>/월</span></div>
                        <div class="pricing-features">
                            <div class="feature-item">✓ 반려동물 3마리까지</div>
                            <div class="feature-item">✓ 기본 건강 기록</div>
                            <div class="feature-item">✓ 사진 10장까지</div>
                            <div class="feature-item">✓ 가족 2명까지</div>
                            <div class="feature-item disabled">✗ 광고 표시</div>
                            <div class="feature-item disabled">✗ 클라우드 백업</div>
                        </div>
                        <button class="pricing-button secondary" disabled>현재 플랜</button>
                    </div>
                    
                    <div class="pricing-card featured">
                        <div class="pricing-badge premium">추천</div>
                        <div id="proPriceDisplay">
                            <div class="pricing-price monthly-price">₩4,900<span>/월</span></div>
                            <div class="pricing-price yearly-price" style="display: none;">
                                ₩49,000<span>/년</span>
                                <div style="font-size: 14px; color: var(--success); margin-top: 8px;">
                                    월 4,083원 (17% 할인!)
                                </div>
                            </div>
                        </div>
                        <div class="pricing-features">
                            <div class="feature-item">✓ 무제한 반려동물</div>
                            <div class="feature-item">✓ 전체 건강 기록</div>
                            <div class="feature-item">✓ 무제한 사진</div>
                            <div class="feature-item">✓ 무제한 가족 공유</div>
                            <div class="feature-item">✓ 광고 없음</div>
                            <div class="feature-item">✓ 클라우드 백업</div>
                            <div class="feature-item">✓ 우선 고객 지원</div>
                        </div>
                        <button class="pricing-button primary" onclick="purchasePremium()">지금 업그레이드</button>
                    </div>
                </div>
                
                <div class="premium-benefits">
                    <div class="benefit-item">
                        <div class="benefit-icon">🚫</div>
                        <div>
                            <div class="benefit-title">광고 없는 경험</div>
                            <div class="benefit-desc">방해받지 않고 집중하세요</div>
                        </div>
                    </div>
                    <div class="benefit-item">
                        <div class="benefit-icon">👨‍👩‍👧‍👦</div>
                        <div>
                            <div class="benefit-title">무제한 가족 공유</div>
                            <div class="benefit-desc">온 가족이 함께 관리하세요</div>
                        </div>
                    </div>
                    <div class="benefit-item">
                        <div class="benefit-icon">📸</div>
                        <div>
                            <div class="benefit-title">무제한 사진 저장</div>
                            <div class="benefit-desc">소중한 추억을 모두 보관</div>
                        </div>
                    </div>
                </div>
                
                <div class="disclaimer" style="margin-top: 20px;">
                    💳 구독은 언제든 취소할 수 있으며, 환불은 결제일로부터 7일 이내 가능합니다.
                </div>
            </div>
        </div>
    </div>

    <!-- Trash Modal -->
    <div class="modal" id="trashModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">🗑️ 휴지통</div>
                <button class="close-btn" onclick="closeModal('trashModal')">×</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                    삭제된 반려동물은 30일 후 자동으로 영구 삭제됩니다.
                </p>
                <div id="trashList"></div>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div class="modal" id="statsModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">📊 통계 & 인사이트</div>
                <button class="close-btn" onclick="closeModal('statsModal')">×</button>
            </div>
            <div class="modal-body">
                <!-- Pet Selector -->
                <div class="form-group" style="margin-bottom: 24px;">
                    <label class="form-label">반려동물 선택</label>
                    <select class="form-select" id="statsPetSelect" onchange="switchPetFromStats(this.value)">
                        <option value="">반려동물 선택...</option>
                    </select>
                </div>
                
                <!-- Period Selector -->
                <div class="filter-tabs" style="margin-bottom: 24px;">
                    <div class="filter-tab active" onclick="switchStatsPeriod('month')">이번 달</div>
                    <div class="filter-tab" onclick="switchStatsPeriod('quarter')">최근 3개월</div>
                    <div class="filter-tab" onclick="switchStatsPeriod('year')">올해</div>
                </div>
                
                <!-- Stats Summary -->
                <div class="stats-grid" style="margin-bottom: 28px;">
                    <div class="stat-card">
                        <div class="stat-value" id="statsVaccinations">0</div>
                        <div class="stat-label">예방접종</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <div class="stat-value" id="statsMeals">0</div>
                        <div class="stat-label">급여 횟수</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <div class="stat-value" id="statsPhotos">0</div>
                        <div class="stat-label">사진</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                        <div class="stat-value" id="statsCost">0원</div>
                        <div class="stat-label">의료비</div>
                    </div>
                </div>
                
                <!-- Charts Section -->
                <div class="stats-charts" style="margin-bottom: 28px;">
                    <!-- Weight Chart -->
                    <div class="chart-container">
                        <div class="chart-header">
                            <div class="chart-title">⚖️ 체중 변화</div>
                            <button class="add-btn" onclick="openAddWeightModal()">+ 기록</button>
                        </div>
                        <div style="position: relative; height: 250px; background: var(--bg-elevated); border-radius: 12px; padding: 20px;">
                            <canvas id="weightChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Medical Cost Chart -->
                    <div class="chart-container" style="margin-top: 20px;">
                        <div class="chart-header">
                            <div class="chart-title">💰 월별 의료비</div>
                        </div>
                        <div style="position: relative; height: 250px; background: var(--bg-elevated); border-radius: 12px; padding: 20px;">
                            <canvas id="costChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Comparison -->
                <div class="stats-comparison">
                    <div class="comparison-title">📈 지난 달 대비</div>
                    <div id="comparisonContent"></div>
                </div>
                
                <!-- Top Items -->
                <div class="stats-top-items">
                    <div class="top-items-title">🏆 이번 달 주요 활동</div>
                    <div id="topItemsContent"></div>
                </div>
                
                <!-- Insights -->
                <div class="stats-insights">
                    <div class="insights-title">💡 인사이트</div>
                    <div id="insightsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trash Bin Modal -->
    <div class="modal" id="trashModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">🗑️ 휴지통</div>
                <button class="close-btn" onclick="closeModal('trashModal')">×</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
                    삭제된 항목은 30일 동안 보관되며, 이후 자동으로 영구 삭제됩니다.
                </p>
                
                <div id="trashList"></div>
                
                <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button class="btn btn-secondary" onclick="emptyTrash()" style="width: 100%;">
                        휴지통 비우기
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- FAQ Modal -->
    <div class="modal" id="faqModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">❓ 자주 묻는 질문</div>
                <button class="close-btn" onclick="closeModal('faqModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="faq-list">
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>Q. 무료 버전과 Pro 버전의 차이가 뭔가요?</span>
                            <span class="faq-icon">▼</span>
                        </div>
                        <div class="faq-answer">
                            <strong>무료 버전:</strong> 반려동물 3마리, 사진 10장, 가족 2명까지, 광고 표시<br><br>
                            <strong>Pro 버전:</strong> 무제한 반려동물, 무제한 사진, 무제한 가족 공유, 광고 없음, 클라우드 백업<br><br>
                            <strong>가격:</strong> 월 4,900원 / 연 49,000원 (17% 할인)
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>Q. 데이터는 어디에 저장되나요?</span>
                            <span class="faq-icon">▼</span>
                        </div>
                        <div class="faq-answer">
                            현재는 브라우저의 로컬 저장소(localStorage)에 저장됩니다.<br>
                            데이터는 기기에만 저장되며, 서버로 전송되지 않습니다.<br><br>
                            <strong>백업 방법:</strong> 설정 > 데이터 내보내기 기능을 사용하세요.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>Q. 사진이 너무 많은데 용량 관리는 어떻게 하나요?</span>
                            <span class="faq-icon">▼</span>
                        </div>
                        <div class="faq-answer">
                            사진은 자동으로 압축되어 저장됩니다 (최대 1200x1200, JPEG 85%).<br>
                            저장 공간이 70% 이상 차면 경고 메시지가 표시됩니다.<br><br>
                            <strong>해결 방법:</strong><br>
                            1. 오래된 사진 삭제<br>
                            2. Pro 버전으로 업그레이드 (클라우드 백업)<br>
                            3. 정기적으로 데이터 내보내기 후 일부 삭제
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>Q. 반려동물을 실수로 삭제했어요!</span>
                            <span class="faq-icon">▼</span>
                        </div>
                        <div class="faq-answer">
                            삭제된 반려동물은 30일 동안 휴지통에 보관됩니다.<br><br>
                            <strong>복원 방법:</strong><br>
                            1. 설정 > 휴지통 메뉴로 이동<br>
                            2. 복원할 반려동물 선택<br>
                            3. "복원" 버튼 클릭<br><br>
                            30일이 지나면 자동으로 영구 삭제되니 주의하세요!
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>Q. 가족과 함께 사용하려면 어떻게 하나요?</span>
                            <span class="faq-icon">▼</span>
                        </div>
                        <div class="faq-answer">
                            홈 화면의 "가족 공유" 카드를 클릭하세요.<br><br>
                            <strong>초대 방법:</strong><br>
                            1. 초대 링크 복사<br>
                            2. 가족에게 전송<br>
                            3. 가족이 링크로 접속<br><br>
                            <strong>주의:</strong> 무료 버전은 2명까지만 가능합니다.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>Q. 알림이 오지 않아요</span>
                            <span class="faq-icon">▼</span>
                        </div>
                        <div class="faq-answer">
                            <strong>확인사항:</strong><br>
                            1. 설정 > 알림 설정이 켜져 있는지 확인<br>
                            2. 브라우저 알림 권한이 허용되어 있는지 확인<br>
                            3. 예방접종/투약 일정이 등록되어 있는지 확인<br><br>
                            <strong>알림 시점:</strong><br>
                            - 예방접종: 3일 전<br>
                            - 투약: 매일 설정 시간
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>Q. 다른 기기에서도 사용할 수 있나요?</span>
                            <span class="faq-icon">▼</span>
                        </div>
                        <div class="faq-answer">
                            현재는 기기별로 데이터가 따로 저장됩니다.<br><br>
                            <strong>데이터 이동 방법:</strong><br>
                            1. 기존 기기: 설정 > 데이터 내보내기<br>
                            2. 새 기기: 설정 > 데이터 가져오기<br><br>
                            Pro 버전에서는 클라우드 백업을 통해 자동 동기화됩니다. (곧 출시)
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <div class="faq-question" onclick="toggleFAQ(this)">
                            <span>Q. 구독을 취소하려면 어떻게 하나요?</span>
                            <span class="faq-icon">▼</span>
                        </div>
                        <div class="faq-answer">
                            설정 > 프리미엄 상태 > "구독 관리" 버튼을 클릭하세요.<br><br>
                            <strong>취소 후:</strong><br>
                            - 이미 결제한 기간까지는 Pro 기능 사용 가능<br>
                            - 기간 종료 후 자동으로 무료 버전으로 전환<br>
                            - 데이터는 유지됩니다 (단, 무료 제한 적용)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Support Modal (1:1 문의) -->
    <div class="modal" id="supportModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">💬 1:1 문의</div>
                <button class="close-btn" onclick="closeModal('supportModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="supportForm" onsubmit="submitSupport(event)">
                    <div class="form-group">
                        <label class="form-label">문의 유형</label>
                        <select class="form-select" id="supportCategory" required>
                            <option value="">선택하세요</option>
                            <option value="account">계정/결제</option>
                            <option value="bug">버그 신고</option>
                            <option value="feature">기능 제안</option>
                            <option value="other">기타</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">이메일</label>
                        <input type="email" class="form-input" id="supportEmail" placeholder="답변 받을 이메일" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">제목</label>
                        <input type="text" class="form-input" id="supportTitle" placeholder="문의 제목" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">내용</label>
                        <textarea class="form-input" id="supportMessage" rows="6" placeholder="문의 내용을 자세히 작성해주세요" required></textarea>
                    </div>
                    
                    <div style="background: rgba(99, 102, 241, 0.1); border-radius: 10px; padding: 12px; margin-bottom: 20px;">
                        <div style="font-size: 13px; color: var(--text-secondary);">
                            💡 <strong>팁:</strong> 버그 신고 시 사용 중인 브라우저와 기기 정보를 함께 알려주시면 빠른 해결에 도움이 됩니다.
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        문의하기
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Weight Modal -->
    <div class="modal" id="addWeightModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <div class="modal-title">⚖️ 체중 기록</div>
                <button class="close-btn" onclick="closeModal('addWeightModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="addWeightForm" onsubmit="submitWeight(event)">
                    <div class="form-group">
                        <label class="form-label">반려동물 *</label>
                        <select class="form-select" id="weightPetSelect" required>
                            <option value="">선택하세요</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">날짜</label>
                        <input type="date" class="form-input" id="weightDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">체중 (kg)</label>
                        <input type="number" class="form-input" id="weightValue" step="0.1" min="0" placeholder="예: 5.5" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">메모 (선택)</label>
                        <textarea class="form-input" id="weightMemo" rows="2" placeholder="특이사항이 있다면 기록하세요"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        기록 추가
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div class="modal" id="onboardingModal" style="z-index: 20000;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-body" style="padding: 40px 30px;">
                <div id="onboardingStep1" class="onboarding-step">
                    <div style="font-size: 64px; text-align: center; margin-bottom: 20px;">🐾</div>
                    <h2 style="text-align: center; font-size: 24px; font-weight: 800; margin-bottom: 12px;">PetCare에 오신 것을 환영합니다!</h2>
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 32px;">
                        반려동물의 건강을 체계적으로 관리하세요
                    </p>
                    <button class="btn btn-primary" onclick="nextOnboardingStep(2)" style="width: 100%;">시작하기</button>
                </div>
                
                <div id="onboardingStep2" class="onboarding-step" style="display: none;">
                    <div style="font-size: 64px; text-align: center; margin-bottom: 20px;">📸</div>
                    <h2 style="text-align: center; font-size: 22px; font-weight: 800; margin-bottom: 12px;">사진 앨범</h2>
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 24px;">
                        소중한 순간을 기록하고<br>추억을 되돌아보세요
                    </p>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="nextOnboardingStep(1)" style="flex: 1;">이전</button>
                        <button class="btn btn-primary" onclick="nextOnboardingStep(3)" style="flex: 1;">다음</button>
                    </div>
                </div>
                
                <div id="onboardingStep3" class="onboarding-step" style="display: none;">
                    <div style="font-size: 64px; text-align: center; margin-bottom: 20px;">🍖</div>
                    <h2 style="text-align: center; font-size: 22px; font-weight: 800; margin-bottom: 12px;">식단 관리</h2>
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 24px;">
                        매일 무엇을 먹였는지 기록하고<br>칼로리와 급여량을 관리하세요
                    </p>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="nextOnboardingStep(2)" style="flex: 1;">이전</button>
                        <button class="btn btn-primary" onclick="nextOnboardingStep(4)" style="flex: 1;">다음</button>
                    </div>
                </div>
                
                <div id="onboardingStep4" class="onboarding-step" style="display: none;">
                    <div style="font-size: 64px; text-align: center; margin-bottom: 20px;">💉</div>
                    <h2 style="text-align: center; font-size: 22px; font-weight: 800; margin-bottom: 12px;">건강 기록</h2>
                    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 24px;">
                        예방접종, 투약, 병원 방문 기록을<br>한 곳에서 관리하세요
                    </p>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="nextOnboardingStep(3)" style="flex: 1;">이전</button>
                        <button class="btn btn-primary" onclick="completeOnboarding()" style="flex: 1;">시작하기</button>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: center; gap: 8px; margin-top: 24px;">
                    <div class="onboarding-dot" id="dot1"></div>
                    <div class="onboarding-dot" id="dot2"></div>
                    <div class="onboarding-dot" id="dot3"></div>
                    <div class="onboarding-dot" id="dot4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')">
            <div class="nav-icon">🏠</div>
            <div class="nav-label">홈</div>
        </div>
        <div class="nav-item" onclick="switchTab('album')">
            <div class="nav-icon">📸</div>
            <div class="nav-label">앨범</div>
        </div>
        <div class="nav-item" onclick="switchTab('meal')">
            <div class="nav-icon">🍖</div>
            <div class="nav-label">식단</div>
        </div>
        <div class="nav-item" onclick="switchTab('hospital')">
            <div class="nav-icon">🏥</div>
            <div class="nav-label">병원</div>
        </div>
        <div class="nav-item" onclick="switchTab('settings')">
            <div class="nav-icon">⚙️</div>
            <div class="nav-label">설정</div>
        </div>
    </div>
    
    <script>
        // Data Storage
        let appData = {
            pets: [],
            currentPetId: null,
            vaccinations: [],
            medications: [],
            hospitals: [],
            isPremium: false,
            premiumExpiry: null,
            subscriptionPeriod: 'monthly',
            photos: [],
            meals: [],
            familyMembers: [
                { id: 1, name: '나', role: '관리자', avatar: '👤' }
            ],
            notifications: {
                vaccination: false,
                medication: false
            },
            trash: {
                pets: [],
                deletedAt: {}
            },
            weightHistory: [] // { petId, weight, date }
        };
        
        let currentRecordType = '';
        let chatHistory = [];
        
        function loadData() {
            const saved = localStorage.getItem('petHealthDiary');
            if (saved) {
                appData = JSON.parse(saved);
                
                // Initialize missing fields for backward compatibility
                if (!appData.weightHistory) {
                    appData.weightHistory = [];
                }
                if (!appData.meals) {
                    appData.meals = [];
                }
                if (!appData.photos) {
                    appData.photos = [];
                }
                if (!appData.familyMembers) {
                    appData.familyMembers = [
                        { id: 1, name: '나', role: '관리자', avatar: '👤' }
                    ];
                }
                if (!appData.notifications) {
                    appData.notifications = {
                        vaccination: false,
                        medication: false
                    };
                }
                if (!appData.trash) {
                    appData.trash = {
                        pets: [],
                        deletedAt: {}
                    };
                }
                
                // Save updated data with new fields
                saveData();
            }
        }
        
        function saveData() {
            localStorage.setItem('petHealthDiary', JSON.stringify(appData));
        }
        
        function init() {
            loadData();
            checkPremiumStatus();
            renderPets();
            if (appData.pets.length > 0) {
                selectPet(appData.currentPetId || appData.pets[0].id);
            }
            document.getElementById('recordDate').valueAsDate = new Date();
            
            // Check if first time user
            checkOnboarding();
        }
        
        // ===== FAQ & SUPPORT FUNCTIONS =====
        function openFAQModal() {
            document.getElementById('faqModal').classList.add('active');
        }
        
        function toggleFAQ(element) {
            const answer = element.nextElementSibling;
            
            // Close all other FAQs
            document.querySelectorAll('.faq-answer').forEach(item => {
                if (item !== answer) {
                    item.classList.remove('active');
                    item.previousElementSibling.classList.remove('active');
                }
            });
            
            // Toggle current FAQ
            answer.classList.toggle('active');
            element.classList.toggle('active');
        }
        
        function openSupportModal() {
            document.getElementById('supportModal').classList.add('active');
        }
        
        function submitSupport(event) {
            event.preventDefault();
            
            const category = document.getElementById('supportCategory').value;
            const email = document.getElementById('supportEmail').value;
            const title = document.getElementById('supportTitle').value;
            const message = document.getElementById('supportMessage').value;
            
            showLoadingToast('문의를 전송하는 중...');
            
            setTimeout(() => {
                const inquiry = {
                    id: Date.now(),
                    category,
                    email,
                    title,
                    message,
                    date: new Date().toISOString()
                };
                
                if (!appData.inquiries) {
                    appData.inquiries = [];
                }
                
                appData.inquiries.push(inquiry);
                saveData();
                
                closeModal('supportModal');
                document.getElementById('supportForm').reset();
                
                showSuccessToast('문의가 접수되었습니다! 빠른 시일 내에 답변드리겠습니다.');
            }, 1500);
        }
        
        // ===== TRASH BIN FUNCTIONS =====
        function openTrashModal() {
            document.getElementById('trashModal').classList.add('active');
            renderTrash();
        }
        
        function renderTrash() {
            const container = document.getElementById('trashList');
            
            if (!appData.trash || !appData.trash.pets || appData.trash.pets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🗑️</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">휴지통이 비어있습니다</div>
                        <div style="font-size: 14px;">삭제된 반려동물이 없습니다</div>
                    </div>
                `;
                return;
            }
            
            // Clean up old items (30 days)
            const now = new Date();
            appData.trash.pets = appData.trash.pets.filter(item => {
                const deletedDate = new Date(appData.trash.deletedAt[item.pet.id]);
                const daysSince = (now - deletedDate) / (1000 * 60 * 60 * 24);
                return daysSince < 30;
            });
            
            saveData();
            updateTrashCount();
            
            container.innerHTML = appData.trash.pets.map(item => {
                const deletedDate = new Date(appData.trash.deletedAt[item.pet.id]);
                const daysLeft = Math.max(0, 30 - Math.floor((now - deletedDate) / (1000 * 60 * 60 * 24)));
                
                return `
                    <div style="background: var(--bg-elevated); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">${item.pet.name}</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">${item.pet.type} · ${item.pet.breed}</div>
                                <div style="font-size: 12px; color: var(--danger); margin-top: 4px;">${daysLeft}일 후 영구 삭제</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="restorePet(${item.pet.id})" style="flex: 1;">복원</button>
                            <button class="btn btn-secondary" onclick="permanentlyDeletePet(${item.pet.id})" style="flex: 1;">영구 삭제</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function restorePet(petId) {
            if (!appData.trash || !appData.trash.pets) return;
            
            const index = appData.trash.pets.findIndex(item => item.pet.id === petId);
            if (index === -1) return;
            
            const item = appData.trash.pets[index];
            
            // Restore pet
            appData.pets.push(item.pet);
            appData.vaccinations.push(...item.vaccinations);
            appData.medications.push(...item.medications);
            appData.hospitals.push(...item.hospitals);
            appData.photos.push(...item.photos);
            appData.meals.push(...item.meals);
            
            // Remove from trash
            appData.trash.pets.splice(index, 1);
            delete appData.trash.deletedAt[petId];
            
            saveData();
            renderTrash();
            updateTrashCount();
            showSuccessToast(`${item.pet.name}이(가) 복원되었습니다`);
        }
        
        function permanentlyDeletePet(petId) {
            if (!appData.trash || !appData.trash.pets) return;
            
            const item = appData.trash.pets.find(i => i.pet.id === petId);
            if (!item) return;
            
            if (!confirm(`${item.pet.name}을(를) 영구적으로 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
                return;
            }
            
            // Remove from trash
            appData.trash.pets = appData.trash.pets.filter(i => i.pet.id !== petId);
            delete appData.trash.deletedAt[petId];
            
            saveData();
            renderTrash();
            updateTrashCount();
            showSuccessToast('영구적으로 삭제되었습니다');
        }
        
        function updateTrashCount() {
            if (!appData.trash || !appData.trash.pets) {
                document.getElementById('trashCount').textContent = '0마리 (30일 후 자동 삭제)';
                return;
            }
            
            const count = appData.trash.pets.length;
            document.getElementById('trashCount').textContent = `${count}마리 (30일 후 자동 삭제)`;
        }
        
        // ===== TRASH BIN FUNCTIONS =====
        function openTrashModal() {
            document.getElementById('trashModal').classList.add('active');
            renderTrash();
        }
        
        function renderTrash() {
            const container = document.getElementById('trashList');
            
            if (!appData.trash || !appData.trash.pets || appData.trash.pets.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 12px;">🗑️</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">휴지통이 비어있습니다</div>
                        <div style="font-size: 14px;">삭제된 항목이 없습니다</div>
                    </div>
                `;
                return;
            }
            
            // Clean up old items (30+ days)
            const now = new Date();
            appData.trash.pets = appData.trash.pets.filter(item => {
                const deletedDate = new Date(appData.trash.deletedAt[item.pet.id]);
                const daysSince = Math.floor((now - deletedDate) / (1000 * 60 * 60 * 24));
                return daysSince < 30;
            });
            
            container.innerHTML = appData.trash.pets.map(item => {
                const pet = item.pet;
                const deletedDate = new Date(appData.trash.deletedAt[pet.id]);
                const daysLeft = 30 - Math.floor((now - deletedDate) / (1000 * 60 * 60 * 24));
                const emoji = pet.type === '강아지' ? '🐕' : pet.type === '고양이' ? '🐈' : '🐾';
                
                return `
                    <div style="background: var(--bg-elevated); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="font-size: 32px;">${emoji}</div>
                                <div>
                                    <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px;">${pet.name}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">${pet.breed || pet.type}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">
                                    ${daysLeft}일 후 삭제
                                </div>
                                <div style="font-size: 11px; color: var(--text-muted);">
                                    ${deletedDate.toLocaleDateString('ko-KR')}
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 12px; font-size: 12px; color: var(--text-secondary);">
                            <div>💉 ${item.vaccinations.length}</div>
                            <div>💊 ${item.medications.length}</div>
                            <div>🏥 ${item.hospitals.length}</div>
                            <div>📸 ${item.photos.length}</div>
                            <div>🍖 ${item.meals.length}</div>
                        </div>
                        
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-primary" onclick="restorePet(${pet.id})" style="flex: 1; padding: 8px; font-size: 13px;">
                                복원
                            </button>
                            <button class="btn btn-secondary" onclick="permanentDeletePet(${pet.id})" style="flex: 1; padding: 8px; font-size: 13px;">
                                영구 삭제
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update count
            updateTrashCount();
        }
        
        function restorePet(petId) {
            const trashItem = appData.trash.pets.find(item => item.pet.id === petId);
            if (!trashItem) return;
            
            if (confirm(`${trashItem.pet.name}을(를) 복원하시겠습니까?`)) {
                // Restore pet
                appData.pets.push(trashItem.pet);
                
                // Restore related data
                appData.vaccinations.push(...trashItem.vaccinations);
                appData.medications.push(...trashItem.medications);
                appData.hospitals.push(...trashItem.hospitals);
                appData.photos.push(...trashItem.photos);
                appData.meals.push(...trashItem.meals);
                
                // Remove from trash
                appData.trash.pets = appData.trash.pets.filter(item => item.pet.id !== petId);
                delete appData.trash.deletedAt[petId];
                
                saveData();
                renderTrash();
                renderPets();
                
                showSuccessToast('복원되었습니다!');
            }
        }
        
        function permanentDeletePet(petId) {
            const trashItem = appData.trash.pets.find(item => item.pet.id === petId);
            if (!trashItem) return;
            
            if (confirm(`${trashItem.pet.name}을(를) 영구적으로 삭제하시겠습니까?\n\n⚠️ 이 작업은 되돌릴 수 없습니다!`)) {
                // Remove from trash
                appData.trash.pets = appData.trash.pets.filter(item => item.pet.id !== petId);
                delete appData.trash.deletedAt[petId];
                
                saveData();
                renderTrash();
                
                showSuccessToast('영구 삭제되었습니다');
            }
        }
        
        function emptyTrash() {
            if (!appData.trash || appData.trash.pets.length === 0) {
                alert('휴지통이 비어있습니다.');
                return;
            }
            
            if (confirm(`휴지통을 비우시겠습니까?\n\n⚠️ ${appData.trash.pets.length}개 항목이 영구 삭제됩니다!`)) {
                appData.trash.pets = [];
                appData.trash.deletedAt = {};
                
                saveData();
                renderTrash();
                
                showSuccessToast('휴지통이 비워졌습니다');
            }
        }
        
        function updateTrashCount() {
            const count = appData.trash?.pets?.length || 0;
            const countText = document.getElementById('trashCountText');
            if (countText) {
                countText.textContent = `삭제된 항목 ${count}개`;
            }
        }
        
        // ===== QUICK DATE FUNCTIONS =====
        let navigationHistory = [];
        
        function goBackFromDetail() {
            if (navigationHistory.length > 0) {
                const previousPage = navigationHistory.pop();
                switchTab(previousPage);
            } else {
                switchTab('home');
            }
            currentDetailType = null;
        }
        
        function openAddFromDetail() {
            if (!appData.currentPetId) {
                alert('먼저 반려동물을 선택해주세요!');
                return;
            }
            
            if (!currentDetailType) {
                alert('기록 유형을 알 수 없습니다. 다시 시도해주세요.');
                return;
            }
            
            console.log('Opening add modal for type:', currentDetailType);
            openAddRecordModal(currentDetailType);
        }
        
        function setQuickDate(type) {
            const dateInput = document.getElementById('recordDate');
            const now = new Date();
            let targetDate;
            
            if (type === 'today') {
                targetDate = now;
            } else if (type === 'yesterday') {
                targetDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            } else if (type === 'week') {
                targetDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            }
            
            dateInput.valueAsDate = targetDate;
        }
        
        // ===== SHARE FUNCTIONS =====
        function sharePhoto() {
            const petPhotos = appData.photos.filter(p => p.petId === appData.currentPetId).sort((a, b) => new Date(b.date) - new Date(a.date));
            const photo = petPhotos[currentPhotoIndex];
            const pet = appData.pets.find(p => p.id === appData.currentPetId);
            
            if (!photo) return;
            
            // Check if Web Share API is available
            if (navigator.share && navigator.canShare) {
                // Convert base64 to blob
                fetch(photo.data)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], `${pet.name}_${new Date(photo.date).toLocaleDateString()}.jpg`, { type: 'image/jpeg' });
                        
                        navigator.share({
                            title: `${pet.name}의 사진`,
                            text: `${new Date(photo.date).toLocaleDateString('ko-KR')} - PetCare로 관리 중`,
                            files: [file]
                        }).catch(err => console.log('Share cancelled'));
                    });
            } else {
                // Fallback: Download image
                const link = document.createElement('a');
                link.download = `${pet.name}_${new Date(photo.date).toLocaleDateString()}.jpg`;
                link.href = photo.data;
                link.click();
                showSuccessToast('사진이 다운로드되었습니다');
            }
        }
        
        function shareHealthReport() {
            if (!appData.currentPetId) return;
            
            const pet = appData.pets.find(p => p.id === appData.currentPetId);
            const vaccinations = appData.vaccinations.filter(v => v.petId === appData.currentPetId);
            const medications = appData.medications.filter(m => m.petId === appData.currentPetId);
            
            const report = `
🐾 ${pet.name}의 건강 기록

📅 생성일: ${new Date().toLocaleDateString('ko-KR')}

💉 예방접종 (${vaccinations.length}건)
${vaccinations.slice(0, 5).map(v => `· ${v.name} - ${formatDate(v.date)}`).join('\n')}

💊 투약 중 (${medications.length}건)
${medications.slice(0, 5).map(m => `· ${m.name} - ${m.frequency}`).join('\n')}

📱 PetCare로 관리 중
            `.trim();
            
            if (navigator.share) {
                navigator.share({
                    title: `${pet.name}의 건강 기록`,
                    text: report
                }).catch(err => console.log('Share cancelled'));
            } else {
                // Fallback: Copy to clipboard
                navigator.clipboard.writeText(report).then(() => {
                    showSuccessToast('건강 기록이 복사되었습니다');
                });
            }
        }
        
        // ===== STATISTICS FUNCTIONS =====
        let currentStatsPeriod = 'month';
        let weightChart = null;
        let costChart = null;
        
        function updateMonthlyStats() {
            if (!appData.currentPetId) return;
            
            // Safety check - initialize if undefined
            if (!appData.meals) appData.meals = [];
            if (!appData.vaccinations) appData.vaccinations = [];
            if (!appData.hospitals) appData.hospitals = [];
            
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            // Count this month's activities
            const monthVaccinations = appData.vaccinations.filter(v => 
                v.petId === appData.currentPetId && 
                new Date(v.date) >= firstDayOfMonth
            ).length;
            
            const monthMeals = appData.meals.filter(m => 
                m.petId === appData.currentPetId && 
                new Date(m.time) >= firstDayOfMonth
            ).length;
            
            const monthHospitals = appData.hospitals.filter(h => 
                h.petId === appData.currentPetId && 
                new Date(h.date) >= firstDayOfMonth
            ).length;
            
            const monthCost = appData.hospitals
                .filter(h => h.petId === appData.currentPetId && new Date(h.date) >= firstDayOfMonth)
                .reduce((sum, h) => sum + (parseInt(h.cost) || 0), 0);
            
            document.getElementById('monthVaccinations').textContent = monthVaccinations;
            document.getElementById('monthMeals').textContent = monthMeals;
            document.getElementById('monthHospitals').textContent = monthHospitals;
            document.getElementById('monthCost').textContent = monthCost.toLocaleString() + '원';
            
            // Show/hide section
            document.getElementById('monthlyStatsSection').style.display = 'block';
        }
        
        function openStatsModal() {
            // Populate pet selector
            populatePetSelector('statsPetSelect');
            
            document.getElementById('statsModal').classList.add('active');
            renderStats(currentStatsPeriod);
        }
        
        function switchPetFromStats(petId) {
            if (!petId) return;
            
            appData.currentPetId = parseInt(petId);
            saveData();
            
            // Re-render stats for selected pet
            renderStats(currentStatsPeriod);
        }
        
        function switchStatsPeriod(period) {
            currentStatsPeriod = period;
            
            // Update tabs
            document.querySelectorAll('#statsModal .filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderStats(period);
        }
        
        function renderStats(period) {
            if (!appData.currentPetId) {
                document.getElementById('statsModal').querySelector('.modal-title').textContent = '📊 통계 & 인사이트';
                return;
            }
            
            // Update modal title with pet name
            const pet = appData.pets.find(p => p.id === appData.currentPetId);
            if (pet) {
                const emoji = pet.type === '강아지' ? '🐕' : pet.type === '고양이' ? '🐈' : '🐾';
                document.getElementById('statsModal').querySelector('.modal-title').textContent = 
                    `📊 ${pet.name}의 통계 & 인사이트`;
            }
            
            const now = new Date();
            let startDate;
            
            if (period === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            } else if (period === 'quarter') {
                startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
            } else { // year
                startDate = new Date(now.getFullYear(), 0, 1);
            }
            
            // Calculate stats
            const vaccinations = appData.vaccinations.filter(v => 
                v.petId === appData.currentPetId && new Date(v.date) >= startDate
            );
            
            const meals = appData.meals.filter(m => 
                m.petId === appData.currentPetId && new Date(m.time) >= startDate
            );
            
            const photos = appData.photos.filter(p => 
                p.petId === appData.currentPetId && new Date(p.date) >= startDate
            );
            
            const hospitals = appData.hospitals.filter(h => 
                h.petId === appData.currentPetId && new Date(h.date) >= startDate
            );
            
            const totalCost = hospitals.reduce((sum, h) => sum + (parseInt(h.cost) || 0), 0);
            
            // Update stats display
            document.getElementById('statsVaccinations').textContent = vaccinations.length;
            document.getElementById('statsMeals').textContent = meals.length;
            document.getElementById('statsPhotos').textContent = photos.length;
            document.getElementById('statsCost').textContent = totalCost.toLocaleString() + '원';
            
            // Render comparison
            renderComparison(period, {vaccinations, meals, photos, hospitals});
            
            // Render top items
            renderTopItems({meals, hospitals});
            
            // Render insights
            renderInsights({vaccinations, meals, photos, hospitals, totalCost});
            
            // Render charts
            renderWeightChart();
            renderCostChart();
        }
        
        function renderComparison(period, currentData) {
            const container = document.getElementById('comparisonContent');
            
            // Calculate previous period data
            const now = new Date();
            let prevStartDate, prevEndDate;
            
            if (period === 'month') {
                prevStartDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                prevEndDate = new Date(now.getFullYear(), now.getMonth(), 0);
            } else if (period === 'quarter') {
                prevStartDate = new Date(now.getTime() - 180 * 24 * 60 * 60 * 1000);
                prevEndDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
            } else {
                prevStartDate = new Date(now.getFullYear() - 1, 0, 1);
                prevEndDate = new Date(now.getFullYear() - 1, 11, 31);
            }
            
            const prevMeals = appData.meals.filter(m => 
                m.petId === appData.currentPetId && 
                new Date(m.time) >= prevStartDate && 
                new Date(m.time) <= prevEndDate
            ).length;
            
            const mealsDiff = currentData.meals.length - prevMeals;
            const mealsPercentage = prevMeals > 0 ? Math.round((mealsDiff / prevMeals) * 100) : 0;
            
            container.innerHTML = `
                <div class="comparison-item">
                    <div>급여 횟수</div>
                    <div class="comparison-change ${mealsDiff >= 0 ? 'positive' : 'negative'}">
                        ${mealsDiff >= 0 ? '↑' : '↓'} ${Math.abs(mealsDiff)}회 (${Math.abs(mealsPercentage)}%)
                    </div>
                </div>
                <div class="comparison-item">
                    <div>사진</div>
                    <div class="comparison-change positive">
                        ↑ ${currentData.photos.length}장
                    </div>
                </div>
            `;
        }
        
        function renderTopItems(data) {
            const container = document.getElementById('topItemsContent');
            
            // Most frequent meal type
            const mealTypes = {};
            data.meals.forEach(m => {
                mealTypes[m.type] = (mealTypes[m.type] || 0) + 1;
            });
            
            const topMeal = Object.entries(mealTypes).sort((a, b) => b[1] - a[1])[0];
            
            // Most expensive hospital visit
            const topHospital = data.hospitals.sort((a, b) => 
                (parseInt(b.cost) || 0) - (parseInt(a.cost) || 0)
            )[0];
            
            container.innerHTML = `
                ${topMeal ? `
                    <div class="top-item">
                        <div style="font-weight: 600; margin-bottom: 4px;">🍖 가장 많이 급여한 식단</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">${topMeal[0]} (${topMeal[1]}회)</div>
                    </div>
                ` : ''}
                ${topHospital && topHospital.cost ? `
                    <div class="top-item">
                        <div style="font-weight: 600; margin-bottom: 4px;">💰 가장 큰 의료비</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">${topHospital.name} - ${parseInt(topHospital.cost).toLocaleString()}원</div>
                    </div>
                ` : ''}
            `;
            
            if (!topMeal && !topHospital) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">아직 데이터가 부족해요</div>';
            }
        }
        
        function renderInsights(data) {
            const container = document.getElementById('insightsContent');
            const insights = [];
            
            // Meal frequency insight
            const avgMealsPerDay = data.meals.length / 30;
            if (avgMealsPerDay < 2) {
                insights.push({
                    icon: '🍖',
                    text: '하루 평균 급여 횟수가 적어요. 규칙적인 식사가 중요해요!'
                });
            } else if (avgMealsPerDay > 4) {
                insights.push({
                    icon: '⚠️',
                    text: '하루 평균 급여 횟수가 많아요. 과식에 주의하세요.'
                });
            }
            
            // Photo insight
            if (data.photos.length === 0) {
                insights.push({
                    icon: '📸',
                    text: '사진을 찍어서 소중한 순간을 기록해보세요!'
                });
            } else if (data.photos.length > 30) {
                insights.push({
                    icon: '🎉',
                    text: `이번 달 ${data.photos.length}장의 추억을 남겼어요!`
                });
            }
            
            // Cost insight
            if (data.totalCost > 100000) {
                insights.push({
                    icon: '💰',
                    text: `이번 달 의료비가 ${data.totalCost.toLocaleString()}원이에요. 펫 보험 가입을 고려해보세요.`
                });
            }
            
            // Vaccination insight
            const upcomingVaccinations = appData.vaccinations.filter(v => {
                if (!v.nextDate) return false;
                const daysUntil = Math.ceil((new Date(v.nextDate) - new Date()) / (1000 * 60 * 60 * 24));
                return daysUntil > 0 && daysUntil <= 30;
            });
            
            if (upcomingVaccinations.length > 0) {
                insights.push({
                    icon: '💉',
                    text: `다가오는 예방접종이 ${upcomingVaccinations.length}개 있어요. 미리 준비하세요!`
                });
            }
            
            container.innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-icon">${insight.icon}</div>
                    <div style="flex: 1;">
                        <div style="font-size: 14px; line-height: 1.6;">${insight.text}</div>
                    </div>
                </div>
            `).join('');
            
            if (insights.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">모든 것이 순조로워요! 👍</div>';
            }
        }
        
        // ===== WEIGHT & CHART FUNCTIONS =====
        function updateCurrentWeight() {
            const weightElement = document.getElementById('currentWeight');
            if (!weightElement || !appData.currentPetId) return;
            
            const weights = (appData.weightHistory || [])
                .filter(w => w.petId === appData.currentPetId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (weights.length > 0) {
                weightElement.textContent = `${weights[0].weight}kg`;
            } else {
                weightElement.textContent = '기록하기';
            }
        }
        
        function openAddWeightModal() {
            // Populate pet selector
            populatePetSelector('weightPetSelect');
            
            // If no pet selected, open modal but require selection
            if (!appData.currentPetId && appData.pets.length === 0) {
                alert('먼저 반려동물을 추가해주세요!');
                return;
            }
            
            document.getElementById('addWeightModal').classList.add('active');
            document.getElementById('weightDate').valueAsDate = new Date();
        }
        
        function submitWeight(event) {
            event.preventDefault();
            
            const selectedPetId = parseInt(document.getElementById('weightPetSelect').value);
            
            if (!selectedPetId) {
                alert('반려동물을 선택해주세요!');
                return;
            }
            
            const weight = {
                id: Date.now(),
                petId: selectedPetId,
                weight: parseFloat(document.getElementById('weightValue').value),
                date: document.getElementById('weightDate').value,
                memo: document.getElementById('weightMemo').value
            };
            
            if (!appData.weightHistory) {
                appData.weightHistory = [];
            }
            
            appData.weightHistory.push(weight);
            
            // Set as current pet if needed
            appData.currentPetId = selectedPetId;
            
            saveData();
            
            closeModal('addWeightModal');
            document.getElementById('addWeightForm').reset();
            
            showSuccessToast('체중이 기록되었습니다');
            
            // Refresh displays
            updateCurrentWeight();
            
            // If stats modal is open, refresh it
            if (document.getElementById('statsModal').classList.contains('active')) {
                renderWeightChart();
                renderStats(currentStatsPeriod);
            }
        }
        
        function renderWeightChart() {
            const canvas = document.getElementById('weightChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (weightChart) {
                weightChart.destroy();
            }
            
            // Get weight history for current pet
            const history = (appData.weightHistory || [])
                .filter(w => w.petId === appData.currentPetId)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (history.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#94a3b8';
                ctx.textAlign = 'center';
                ctx.fillText('체중 기록이 없습니다', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const labels = history.map(w => new Date(w.date).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }));
            const data = history.map(w => w.weight);
            
            weightChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '체중 (kg)',
                        data: data,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#6366f1',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(1) + ' kg';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#94a3b8',
                                callback: function(value) {
                                    return value.toFixed(1) + ' kg';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        }
        
        function renderCostChart() {
            const canvas = document.getElementById('costChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (costChart) {
                costChart.destroy();
            }
            
            // Get medical costs by month (last 6 months)
            const hospitals = appData.hospitals.filter(h => h.petId === appData.currentPetId && h.cost);
            
            if (hospitals.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#94a3b8';
                ctx.textAlign = 'center';
                ctx.fillText('의료비 기록이 없습니다', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Group by month
            const monthlyData = {};
            const now = new Date();
            
            // Initialize last 6 months
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[key] = 0;
            }
            
            // Sum costs by month
            hospitals.forEach(h => {
                const date = new Date(h.date);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (monthlyData.hasOwnProperty(key)) {
                    monthlyData[key] += parseInt(h.cost) || 0;
                }
            });
            
            const labels = Object.keys(monthlyData).map(key => {
                const [year, month] = key.split('-');
                return `${month}월`;
            });
            const data = Object.values(monthlyData);
            
            costChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '의료비 (원)',
                        data: data,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: '#ef4444',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            borderColor: '#ef4444',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString() + '원';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#94a3b8',
                                callback: function(value) {
                                    return (value / 1000).toFixed(0) + 'K';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        }
                    }
                }
            });
        }
        
        // ===== NOTIFICATION SYSTEM =====
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                alert("이 브라우저는 알림을 지원하지 않습니다.");
                return;
            }
            
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    showSuccessToast("알림 권한이 허용되었습니다");
                    document.getElementById('notificationPermissionWarning').style.display = 'none';
                    checkNotifications();
                } else {
                    alert("알림 권한이 거부되었습니다. 브라우저 설정에서 권한을 허용해주세요.");
                }
            });
        }
        
        function toggleNotifications(type, enabled) {
            if (!appData.notifications) {
                appData.notifications = {
                    vaccination: false,
                    medication: false
                };
            }
            
            if (enabled && Notification.permission !== "granted") {
                document.getElementById('notificationPermissionWarning').style.display = 'block';
                document.getElementById(`${type}Notif`).checked = false;
                return;
            }
            
            appData.notifications[type] = enabled;
            saveData();
            
            if (enabled) {
                scheduleNotifications(type);
                showSuccessToast(`${type === 'vaccination' ? '예방접종' : '투약'} 알림이 켜졌습니다`);
            }
        }
        
        function scheduleNotifications(type) {
            // Check upcoming events
            if (type === 'vaccination') {
                appData.vaccinations.forEach(v => {
                    if (v.nextDate) {
                        const daysUntil = Math.ceil((new Date(v.nextDate) - new Date()) / (1000 * 60 * 60 * 24));
                        
                        if (daysUntil <= 3 && daysUntil > 0) {
                            const pet = appData.pets.find(p => p.id === v.petId);
                            showNotification(
                                `${pet ? pet.name : '반려동물'} 예방접종 예정`,
                                `${v.name} - ${daysUntil}일 후 (${formatDate(v.nextDate)})`
                            );
                        }
                    }
                });
            } else if (type === 'medication') {
                appData.medications.forEach(m => {
                    const pet = appData.pets.find(p => p.id === m.petId);
                    showNotification(
                        `${pet ? pet.name : '반려동물'} 투약 시간`,
                        `${m.name} - ${m.frequency || '매일'}`
                    );
                });
            }
        }
        
        function showNotification(title, body) {
            if (Notification.permission === "granted") {
                new Notification(title, {
                    body: body,
                    icon: '🐾',
                    badge: '🐾'
                });
            }
        }
        
        function checkNotifications() {
            // Load notification settings
            if (appData.notifications) {
                document.getElementById('vaccinationNotif').checked = appData.notifications.vaccination || false;
                document.getElementById('medicationNotif').checked = appData.notifications.medication || false;
            }
            
            // Show warning if permission not granted
            if (Notification.permission !== "granted" && 
                (appData.notifications?.vaccination || appData.notifications?.medication)) {
                document.getElementById('notificationPermissionWarning').style.display = 'block';
            }
            
            // Schedule daily check (in production, use Service Worker)
            if (appData.notifications?.vaccination || appData.notifications?.medication) {
                setInterval(() => {
                    if (appData.notifications.vaccination) {
                        scheduleNotifications('vaccination');
                    }
                    if (appData.notifications.medication) {
                        scheduleNotifications('medication');
                    }
                }, 24 * 60 * 60 * 1000); // Daily
            }
        }
        
        // Initialize notifications on load
        window.addEventListener('load', () => {
            checkNotifications();
        });
        
        // ===== ONBOARDING FUNCTIONS =====
        let currentOnboardingStep = 1;
        
        function checkOnboarding() {
            const hasSeenOnboarding = localStorage.getItem('petcare_onboarding_complete');
            
            if (!hasSeenOnboarding && appData.pets.length === 0) {
                setTimeout(() => {
                    document.getElementById('onboardingModal').classList.add('active');
                    updateOnboardingDots();
                }, 500);
            }
        }
        
        function nextOnboardingStep(step) {
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`onboardingStep${i}`).style.display = 'none';
            }
            
            // Show target step
            document.getElementById(`onboardingStep${step}`).style.display = 'block';
            currentOnboardingStep = step;
            updateOnboardingDots();
        }
        
        function updateOnboardingDots() {
            for (let i = 1; i <= 4; i++) {
                const dot = document.getElementById(`dot${i}`);
                if (i === currentOnboardingStep) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            }
        }
        
        function completeOnboarding() {
            localStorage.setItem('petcare_onboarding_complete', 'true');
            closeModal('onboardingModal');
            
            // Open add pet modal
            setTimeout(() => {
                openAddPetModal();
            }, 300);
        }
        
        // Premium Functions
        let selectedPeriod = 'monthly';
        
        function checkPremiumStatus() {
            const isPremium = appData.isPremium && (!appData.premiumExpiry || new Date(appData.premiumExpiry) > new Date());
            
            if (isPremium) {
                // Hide ads (모든 광고 숨김)
                const adBanner = document.getElementById('adBanner');
                const bottomAd = document.getElementById('bottomAd');
                const googleAdBanner = document.getElementById('googleAdBanner'); // Google AdSense
                if (adBanner) adBanner.style.display = 'none';
                if (bottomAd) bottomAd.style.display = 'none';
                if (googleAdBanner) googleAdBanner.style.display = 'none'; // AdSense도 숨김
                
                // Show premium badge
                document.getElementById('premiumBadge').style.display = 'inline-block';
            } else {
                // Show ads (무료 사용자에게 광고 표시)
                const adBanner = document.getElementById('adBanner');
                const bottomAd = document.getElementById('bottomAd');
                const googleAdBanner = document.getElementById('googleAdBanner'); // Google AdSense
                if (adBanner) adBanner.style.display = 'block';
                if (bottomAd) bottomAd.style.display = 'block';
                if (googleAdBanner) googleAdBanner.style.display = 'block'; // AdSense도 표시
                
                // Hide premium badge
                document.getElementById('premiumBadge').style.display = 'none';
            }
        }
        
        function openPremiumModal() {
            document.getElementById('premiumModal').classList.add('active');
            selectedPeriod = 'monthly';
            switchPeriod('monthly');
        }
        
        function switchPeriod(period) {
            selectedPeriod = period;
            
            // Update tabs
            document.getElementById('monthlyTab').classList.toggle('active', period === 'monthly');
            document.getElementById('yearlyTab').classList.toggle('active', period === 'yearly');
            
            // Update price display
            document.querySelectorAll('.monthly-price').forEach(el => {
                el.style.display = period === 'monthly' ? 'block' : 'none';
            });
            document.querySelectorAll('.yearly-price').forEach(el => {
                el.style.display = period === 'yearly' ? 'block' : 'none';
            });
        }
        
        function purchasePremium() {
            const price = selectedPeriod === 'monthly' ? '월 4,900원' : '연 49,000원 (월 4,083원)';
            const periodText = selectedPeriod === 'monthly' ? '월간' : '연간';
            
            // In a real app, this would integrate with payment gateway (Stripe, PayPal, etc.)
            if (confirm(`펫케어 AI Pro ${periodText} 구독을 시작하시겠습니까?\n\n${price}이 결제됩니다.\n(이 데모에서는 실제 결제가 되지 않습니다)`)) {
                // Set premium status
                appData.isPremium = true;
                const expiryDate = new Date();
                if (selectedPeriod === 'yearly') {
                    expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                } else {
                    expiryDate.setMonth(expiryDate.getMonth() + 1);
                }
                appData.premiumExpiry = expiryDate.toISOString();
                appData.subscriptionPeriod = selectedPeriod;
                
                saveData();
                checkPremiumStatus();
                closeModal('premiumModal');
                
                const savings = selectedPeriod === 'yearly' ? '\n연간 구독으로 10,800원 절약!' : '';
                alert(`🎉 축하합니다!\n\n펫케어 AI Pro 구독이 시작되었습니다.\n광고 없이 모든 기능을 무제한으로 사용하세요!${savings}`);
                
                // Reload to show changes
                location.reload();
            }
        }
        
        function cancelSubscription() {
            if (confirm('구독을 취소하시겠습니까?\n\n현재 결제 기간이 끝날 때까지는 Pro 기능을 계속 사용할 수 있습니다.')) {
                appData.isPremium = false;
                appData.premiumExpiry = null;
                saveData();
                alert('구독이 취소되었습니다.');
                location.reload();
            }
        }
        
        function hideAd() {
            document.getElementById('adBanner').style.display = 'none';
            // Save preference for this session
            sessionStorage.setItem('adHidden', 'true');
        }
        
        function renderPets() {
            const container = document.getElementById('petSelector');
            const addBtn = container.querySelector('.add-pet');
            container.innerHTML = '';
            
            appData.pets.forEach(pet => {
                const card = document.createElement('div');
                card.className = 'pet-card';
                if (pet.id === appData.currentPetId) {
                    card.classList.add('active');
                }
                
                const emoji = pet.type === '강아지' ? '🐕' : pet.type === '고양이' ? '🐈' : '🐾';
                const age = pet.birthday ? calculateAge(pet.birthday) : '';
                
                card.innerHTML = `
                    <div class="pet-avatar">${emoji}</div>
                    <div class="pet-name">${pet.name}</div>
                    <div class="pet-info">${pet.breed || pet.type}${age ? ' · ' + age : ''}</div>
                `;
                card.onclick = () => selectPet(pet.id);
                container.appendChild(card);
            });
            
            container.appendChild(addBtn);
        }
        
        function calculateAge(birthday) {
            const birth = new Date(birthday);
            const now = new Date();
            const years = now.getFullYear() - birth.getFullYear();
            const months = now.getMonth() - birth.getMonth();
            
            if (years > 0) {
                return years + '살';
            } else if (months > 0) {
                return months + '개월';
            }
            return '신생';
        }
        
        function selectPet(petId) {
            appData.currentPetId = petId;
            saveData();
            renderPets();
            renderRecords();
            updateStats();
            updateAlerts();
            
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('practicalFeatures').style.display = 'grid';
            document.getElementById('vaccinationsSection').style.display = 'block';
            document.getElementById('medicationsSection').style.display = 'block';
            document.getElementById('hospitalSection').style.display = 'block';
            
            updateMonthlyStats();
            updateCurrentWeight();
            document.getElementById('statsGrid').style.display = 'grid';
            
            const pet = appData.pets.find(p => p.id === petId);
            document.getElementById('headerSubtitle').textContent = `${pet.name}의 건강을 펫케어가 관리해드려요`;
        }
        
        function renderRecords() {
            if (!appData.currentPetId) return;
            
            const petVaccinations = appData.vaccinations.filter(v => v.petId === appData.currentPetId);
            const petMedications = appData.medications.filter(m => m.petId === appData.currentPetId);
            const petHospitals = appData.hospitals.filter(h => h.petId === appData.currentPetId);
            
            renderVaccinations(petVaccinations);
            renderMedications(petMedications);
            renderHospitals(petHospitals);
        }
        
        function renderVaccinations(items) {
            const container = document.getElementById('vaccinationsList');
            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state"><div style="opacity: 0.5;">예방접종 기록이 없습니다</div></div>';
                return;
            }
            
            container.innerHTML = items.sort((a, b) => new Date(b.date) - new Date(a.date)).map(item => `
                <div class="record-item vaccination">
                    <div class="record-header">
                        <div class="record-title">${item.name}</div>
                        <div class="record-date">${formatDate(item.date)}</div>
                    </div>
                    ${item.notes ? `<div class="record-detail">${item.notes}</div>` : ''}
                    ${item.nextDate ? `<div class="next-date">다음: ${formatDate(item.nextDate)}</div>` : ''}
                </div>
            `).join('');
        }
        
        function renderMedications(items) {
            const container = document.getElementById('medicationsList');
            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state"><div style="opacity: 0.5;">투약 기록이 없습니다</div></div>';
                return;
            }
            
            container.innerHTML = items.sort((a, b) => new Date(b.date) - new Date(a.date)).map(item => `
                <div class="record-item medication">
                    <div class="record-header">
                        <div class="record-title">${item.name}</div>
                        <div class="record-date">${formatDate(item.date)}</div>
                    </div>
                    ${item.frequency ? `<div class="record-detail">복용 주기: ${item.frequency}</div>` : ''}
                    ${item.notes ? `<div class="record-detail">${item.notes}</div>` : ''}
                </div>
            `).join('');
        }
        
        function renderHospitals(items) {
            const container = document.getElementById('hospitalList');
            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state"><div style="opacity: 0.5;">병원 기록이 없습니다</div></div>';
                return;
            }
            
            container.innerHTML = items.sort((a, b) => new Date(b.date) - new Date(a.date)).map(item => `
                <div class="record-item hospital">
                    <div class="record-header">
                        <div class="record-title">${item.name}</div>
                        <div class="record-date">${formatDate(item.date)}</div>
                    </div>
                    ${item.notes ? `<div class="record-detail">${item.notes}</div>` : ''}
                    ${item.cost ? `<div class="record-detail">비용: ${parseInt(item.cost).toLocaleString()}원</div>` : ''}
                </div>
            `).join('');
        }
        
        function updateStats() {
            if (!appData.currentPetId) return;
            
            const vacCount = appData.vaccinations.filter(v => v.petId === appData.currentPetId).length;
            const medCount = appData.medications.filter(m => m.petId === appData.currentPetId).length;
            
            document.getElementById('vaccinationCount').textContent = vacCount;
            document.getElementById('medicationCount').textContent = medCount;
        }
        
        function updateAlerts() {
            if (!appData.currentPetId) return;
            
            const alerts = [];
            const today = new Date();
            const oneWeekLater = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            appData.vaccinations
                .filter(v => v.petId === appData.currentPetId && v.nextDate)
                .forEach(v => {
                    const nextDate = new Date(v.nextDate);
                    if (nextDate >= today && nextDate <= oneWeekLater) {
                        const daysLeft = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
                        alerts.push({
                            icon: '💉',
                            title: v.name,
                            time: daysLeft === 0 ? '오늘' : `${daysLeft}일 후`
                        });
                    }
                });
            
            const alertsContainer = document.getElementById('upcomingAlerts');
            const alertsList = document.getElementById('alertsList');
            
            if (alerts.length > 0) {
                alertsContainer.style.display = 'block';
                alertsList.innerHTML = alerts.map(a => `
                    <div class="alert-item">
                        <div class="alert-icon">${a.icon}</div>
                        <div class="alert-content">
                            <div class="alert-title">${a.title}</div>
                            <div class="alert-time">${a.time}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                alertsContainer.style.display = 'none';
            }
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}.${month}.${day}`;
        }
        
        function openAddPetModal() {
            document.getElementById('addPetModal').classList.add('active');
        }
        
        function openAddRecordModal(type) {
            currentRecordType = type;
            const modal = document.getElementById('addRecordModal');
            const title = document.getElementById('recordModalTitle');
            const nameLabel = document.getElementById('recordNameLabel');
            const nextDateGroup = document.getElementById('nextDateGroup');
            const frequencyGroup = document.getElementById('frequencyGroup');
            const costGroup = document.getElementById('costGroup');
            
            document.getElementById('addRecordForm').reset();
            document.getElementById('recordDate').valueAsDate = new Date();
            
            if (type === 'vaccination') {
                title.textContent = '예방접종 추가';
                nameLabel.textContent = '백신 이름 *';
                nextDateGroup.style.display = 'block';
                frequencyGroup.style.display = 'none';
                costGroup.style.display = 'none';
            } else if (type === 'medication') {
                title.textContent = '투약 일정 추가';
                nameLabel.textContent = '약 이름 *';
                nextDateGroup.style.display = 'none';
                frequencyGroup.style.display = 'block';
                costGroup.style.display = 'none';
            } else if (type === 'hospital') {
                title.textContent = '병원 기록 추가';
                nameLabel.textContent = '방문 목적 *';
                nextDateGroup.style.display = 'none';
                frequencyGroup.style.display = 'none';
                costGroup.style.display = 'block';
            }
            
            modal.classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function openPhotoAnalysis() {
            if (!appData.currentPetId) {
                alert('먼저 반려동물을 선택해주세요!');
                return;
            }
            document.getElementById('photoAnalysisModal').classList.add('active');
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('previewImage').style.display = 'none';
            document.getElementById('analysisResult').style.display = 'none';
            document.getElementById('analysisLoading').style.display = 'none';
            document.getElementById('photoDisclaimer').style.display = 'none';
        }
        
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('uploadArea').style.display = 'none';
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('previewImage').style.display = 'block';
                analyzePhoto(e.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        function analyzePhoto(imageData) {
            document.getElementById('analysisLoading').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('analysisLoading').style.display = 'none';
                document.getElementById('photoDisclaimer').style.display = 'block';
                
                const pet = appData.pets.find(p => p.id === appData.currentPetId);
                const result = generateMockAnalysis(pet);
                
                document.getElementById('analysisResult').innerHTML = `
                    <div class="analysis-result">
                        <div class="analysis-header">
                            🤖 AI 분석 결과
                        </div>
                        <div class="severity-badge ${result.severityClass}">
                            ${result.severity}
                        </div>
                        <div class="analysis-section">
                            <h4>📋 관찰된 증상</h4>
                            <p>${result.observation}</p>
                        </div>
                        <div class="analysis-section">
                            <h4>🔍 가능한 원인</h4>
                            <p>${result.possibleCause}</p>
                        </div>
                        <div class="analysis-section">
                            <h4>💡 권장사항</h4>
                            <p>${result.recommendation}</p>
                        </div>
                        <div class="analysis-section">
                            <h4>⚠️ 응급도</h4>
                            <p>${result.urgency}</p>
                        </div>
                    </div>
                `;
                document.getElementById('analysisResult').style.display = 'block';
            }, 2000);
        }
        
        function generateMockAnalysis(pet) {
            const analyses = [
                {
                    severity: '정상',
                    severityClass: 'severity-low',
                    observation: '피부와 털 상태가 전반적으로 양호해 보입니다. 특별한 이상 징후는 발견되지 않았습니다.',
                    possibleCause: '건강한 상태로 판단됩니다.',
                    recommendation: '현재 상태를 유지하세요. 정기적인 목욕과 빗질을 계속해주세요.',
                    urgency: '낮음 - 정기 검진 시 확인'
                },
                {
                    severity: '주의 필요',
                    severityClass: 'severity-medium',
                    observation: '피부에 약간의 발진이나 붉은 반점이 보입니다.',
                    possibleCause: '알레르기 반응, 벼룩 물림, 또는 접촉성 피부염 가능성이 있습니다.',
                    recommendation: '48시간 이내 동물병원 방문을 권장합니다. 반려동물이 해당 부위를 긁지 못하도록 주의하세요.',
                    urgency: '중간 - 2일 내 병원 방문'
                },
                {
                    severity: '즉시 진료 권장',
                    severityClass: 'severity-high',
                    observation: '피부에 심한 발진, 탈모, 또는 염증이 관찰됩니다.',
                    possibleCause: '심각한 피부 감염, 진균 감염, 또는 자가면역 질환 가능성이 있습니다.',
                    recommendation: '24시간 이내 동물병원 응급 진료를 받으세요. 증상이 악화되면 즉시 방문하세요.',
                    urgency: '높음 - 당일 응급 진료'
                }
            ];
            
            return analyses[Math.floor(Math.random() * analyses.length)];
        }
        
        function openSymptomChat() {
            if (!appData.currentPetId) {
                alert('먼저 반려동물을 선택해주세요!');
                return;
            }
            document.getElementById('symptomChatModal').classList.add('active');
            
            chatHistory = [];
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="chat-message">
                    <div class="message-avatar ai">🤖</div>
                    <div class="message-bubble ai">
                        안녕하세요! 반려동물의 증상을 알려주시면 도움을 드리겠습니다. 어떤 증상이 있나요?
                    </div>
                </div>
            `;
        }
        
        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage(message, 'user');
            input.value = '';
            
            setTimeout(() => {
                const response = generateChatResponse(message);
                addChatMessage(response, 'ai');
            }, 1000);
        }
        
        function addChatMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            const avatar = sender === 'ai' ? '🤖' : '👤';
            const avatarClass = sender === 'ai' ? 'ai' : 'user';
            
            messageDiv.innerHTML = `
                <div class="message-avatar ${avatarClass}">${avatar}</div>
                <div class="message-bubble ${sender}">${text}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            chatHistory.push({ sender, text });
        }
        
        function generateChatResponse(userMessage) {
            const lowerMsg = userMessage.toLowerCase();
            
            if (lowerMsg.includes('구토') || lowerMsg.includes('토')) {
                return '구토 증상이 있군요. 몇 가지 질문드리겠습니다:\n\n1. 얼마나 자주 구토하나요?\n2. 구토물에 피가 섞여있나요?\n3. 식욕은 어떤가요?\n\n이 정보를 알려주시면 더 정확한 조언을 드릴 수 있습니다.';
            } else if (lowerMsg.includes('설사')) {
                return '설사 증상이 있으시군요. 다음 사항을 확인해주세요:\n\n1. 설사의 색깔과 농도\n2. 하루에 몇 번 정도인지\n3. 혈변 여부\n\n심한 설사는 탈수를 유발할 수 있으니 24시간 이상 지속되면 병원 방문을 권장합니다.';
            } else if (lowerMsg.includes('가려')) {
                return '가려움증이 있나보네요. 가능한 원인은:\n\n• 벼룩이나 진드기\n• 알레르기 (음식, 환경)\n• 피부 감염\n• 건조한 피부\n\n특정 부위를 집중적으로 긁나요? 사진으로 해당 부위를 보여주시면 더 정확한 분석이 가능합니다.';
            } else if (lowerMsg.includes('안먹') || lowerMsg.includes('식욕')) {
                return '식욕 부진은 다양한 원인이 있을 수 있습니다:\n\n• 스트레스\n• 치아/잇몸 문제\n• 소화기 질환\n• 발열이나 감염\n\n다른 증상 (무기력, 구토 등)이 동반되나요? 24시간 이상 먹지 않으면 병원 방문이 필요합니다.';
            } else {
                return '증상을 자세히 설명해주시면 더 도움을 드릴 수 있습니다. 다음과 같은 정보가 있으면 좋습니다:\n\n• 언제부터 증상이 시작됐나요?\n• 증상의 빈도는?\n• 다른 동반 증상은?\n• 최근 환경 변화가 있었나요?';
            }
        }
        
        function openHealthReport() {
            if (!appData.currentPetId) {
                alert('먼저 반려동물을 선택해주세요!');
                return;
            }
            document.getElementById('healthReportModal').classList.add('active');
            generateHealthReport();
        }
        
        function generateHealthReport() {
            const pet = appData.pets.find(p => p.id === appData.currentPetId);
            const vaccinations = appData.vaccinations.filter(v => v.petId === appData.currentPetId);
            const medications = appData.medications.filter(m => m.petId === appData.currentPetId);
            const hospitals = appData.hospitals.filter(h => h.petId === appData.currentPetId);
            
            setTimeout(() => {
                let score = 70;
                
                if (vaccinations.length > 0) score += 10;
                if (vaccinations.length > 3) score += 5;
                if (hospitals.length > 0) score += 5;
                if (pet.weight) score += 5;
                if (pet.birthday) score += 5;
                
                score = Math.min(score, 100);
                
                const scoreColor = score >= 80 ? '#10b981' : score >= 60 ? '#f59e0b' : '#ef4444';
                
                const reportHTML = `
                    <div class="health-score" style="background: linear-gradient(135deg, ${scoreColor} 0%, ${scoreColor}dd 100%);">
                        <div class="score-value">${score}</div>
                        <div class="score-label">건강 점수</div>
                    </div>
                    
                    <div class="report-section" style="border-left-color: ${scoreColor};">
                        <h3>✅ 잘하고 있는 점</h3>
                        <ul>
                            ${vaccinations.length > 0 ? '<li>예방접종 기록을 잘 관리하고 계시네요!</li>' : ''}
                            ${medications.length > 0 ? '<li>투약 일정을 체계적으로 관리 중입니다.</li>' : ''}
                            ${hospitals.length > 0 ? '<li>정기적인 병원 방문 기록이 있습니다.</li>' : ''}
                            ${pet.birthday ? '<li>생일 정보가 등록되어 나이별 케어가 가능합니다.</li>' : ''}
                            ${pet.weight ? '<li>체중 정보가 등록되어 있습니다.</li>' : ''}
                        </ul>
                    </div>
                    
                    <div class="report-section" style="border-left-color: #f59e0b;">
                        <h3>⚠️ 개선이 필요한 점</h3>
                        <ul>
                            ${vaccinations.length === 0 ? '<li>예방접종 기록을 추가해보세요. 정기적인 예방접종은 필수입니다.</li>' : ''}
                            ${!pet.weight ? '<li>체중 정보를 추가하면 건강 변화를 추적할 수 있습니다.</li>' : ''}
                            ${hospitals.length < 2 ? '<li>정기 검진 기록을 추가하면 더 체계적인 관리가 가능합니다.</li>' : ''}
                            ${!pet.birthday ? '<li>생일을 등록하면 나이별 맞춤 케어 정보를 제공받을 수 있습니다.</li>' : ''}
                        </ul>
                    </div>
                    
                    <div class="report-section" style="border-left-color: #3b82f6;">
                        <h3>💡 AI 추천 사항</h3>
                        <ul>
                            ${pet.type === '강아지' ? '<li>강아지는 매년 종합 백신 접종이 필요합니다.</li>' : ''}
                            ${pet.type === '고양이' ? '<li>고양이는 연 1회 건강검진을 권장합니다.</li>' : ''}
                            <li>반려동물의 증상이 있다면 AI 사진 분석이나 증상 상담을 이용해보세요.</li>
                            <li>정기적인 치아 관리가 전체 건강에 중요합니다.</li>
                            ${!pet.weight ? '<li>체중을 정기적으로 기록하여 비만이나 저체중을 예방하세요.</li>' : ''}
                        </ul>
                    </div>
                    
                    <div class="disclaimer">
                        이 리포트는 AI가 입력된 데이터를 기반으로 생성한 것으로, 수의사의 전문적인 진단을 대체할 수 없습니다.
                    </div>
                `;
                
                document.getElementById('reportContent').innerHTML = reportHTML;
            }, 1500);
        }
        
        document.getElementById('addPetForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newPet = {
                id: Date.now(),
                name: document.getElementById('petName').value,
                type: document.getElementById('petType').value,
                breed: document.getElementById('petBreed').value,
                birthday: document.getElementById('petBirthday').value,
                weight: document.getElementById('petWeight').value
            };
            
            appData.pets.push(newPet);
            saveData();
            renderPets();
            selectPet(newPet.id);
            closeModal('addPetModal');
            
            // Show success message
            showSuccessToast(`${newPet.name}이(가) 추가되었습니다!`);
            
            // Navigate to home
            switchTab('home');
            
            e.target.reset();
        });
        
        document.getElementById('addRecordForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const record = {
                id: Date.now(),
                petId: appData.currentPetId,
                name: document.getElementById('recordName').value,
                date: document.getElementById('recordDate').value,
                notes: document.getElementById('recordNotes').value
            };
            
            if (currentRecordType === 'vaccination') {
                record.nextDate = document.getElementById('recordNextDate').value;
                appData.vaccinations.push(record);
            } else if (currentRecordType === 'medication') {
                record.frequency = document.getElementById('recordFrequency').value;
                appData.medications.push(record);
            } else if (currentRecordType === 'hospital') {
                record.cost = document.getElementById('recordCost').value;
                appData.hospitals.push(record);
            }
            
            saveData();
            renderRecords();
            updateStats();
            updateAlerts();
            
            // Refresh detail page if currently viewing
            if (currentDetailType) {
                renderRecordsDetail(currentDetailType);
            }
            
            closeModal('addRecordModal');
            
            showSuccessToast('기록이 추가되었습니다');
            
            e.target.reset();
        });
        
        init();
        
        // Hospital Search Functions
        let userCoords = null;
        let nearbyHospitals = [];
        let allHospitals = [];
        let currentSearchMode = 'nearby';
        let selectedRegion = { sido: '', sigungu: '', dong: '' };
        
        // Korea administrative divisions data
        const koreaRegions = {
            '서울특별시': {
                '강남구': ['역삼동', '삼성동', '청담동', '논현동', '신사동', '압구정동', '대치동', '개포동', '도곡동'],
                '강동구': ['천호동', '성내동', '길동', '둔촌동', '암사동', '명일동', '고덕동', '상일동'],
                '강북구': ['미아동', '수유동', '번동', '우이동'],
                '강서구': ['염창동', '등촌동', '화곡동', '가양동', '마곡동', '내발산동', '외발산동', '공항동', '방화동'],
                '관악구': ['봉천동', '신림동', '남현동'],
                '광진구': ['중곡동', '능동', '구의동', '광장동', '자양동', '화양동'],
                '구로구': ['신도림동', '구로동', '가리봉동', '고척동', '개봉동', '오류동', '궁동', '온수동', '천왕동', '항동'],
                '금천구': ['가산동', '독산동', '시흥동'],
                '노원구': ['월계동', '공릉동', '하계동', '상계동', '중계동'],
                '도봉구': ['쌍문동', '방학동', '창동', '도봉동'],
                '동대문구': ['용두동', '제기동', '전농동', '답십리동', '장안동', '청량리동', '회기동', '휘경동', '이문동'],
                '동작구': ['노량진동', '상도동', '흑석동', '사당동', '대방동', '신대방동'],
                '마포구': ['아현동', '공덕동', '도화동', '용강동', '대흥동', '염리동', '신수동', '서강동', '서교동', '합정동', '망원동', '연남동', '성산동', '상암동'],
                '서대문구': ['충정로', '천연동', '신촌동', '연희동', '홍제동', '홍은동', '북아현동', '북가좌동', '남가좌동'],
                '서초구': ['서초동', '잠원동', '반포동', '방배동', '양재동', '내곡동'],
                '성동구': ['왕십리도선동', '마장동', '사근동', '행당동', '응봉동', '금호동', '옥수동', '성수동', '송정동', '용답동'],
                '성북구': ['성북동', '삼선동', '동선동', '돈암동', '안암동', '보문동', '정릉동', '길음동', '종암동', '하월곡동', '상월곡동', '장위동', '석관동'],
                '송파구': ['잠실동', '신천동', '풍납동', '송파동', '석촌동', '삼전동', '가락동', '문정동', '장지동', '방이동', '오금동', '거여동', '마천동'],
                '양천구': ['신정동', '목동', '신월동'],
                '영등포구': ['영등포동', '여의도동', '당산동', '도림동', '문래동', '양평동', '신길동', '대림동'],
                '용산구': ['후암동', '용산동', '남영동', '청파동', '원효로', '효창동', '도원동', '산천동', '청암동', '이태원동', '한남동', '서빙고동', '보광동'],
                '은평구': ['수색동', '녹번동', '불광동', '갈현동', '구산동', '대조동', '응암동', '역촌동', '신사동', '증산동', '진관동'],
                '종로구': ['청운효자동', '사직동', '삼청동', '부암동', '평창동', '무악동', '교남동', '가회동', '종로', '이화동', '혜화동', '창신동', '숭인동'],
                '중구': ['소공동', '회현동', '명동', '필동', '장충동', '광희동', '을지로', '신당동', '다산동', '약수동', '청구동', '신당동', '동화동', '황학동', '중림동'],
                '중랑구': ['면목동', '상봉동', '중화동', '묵동', '망우동', '신내동']
            },
            '부산광역시': {
                '강서구': ['가덕도동', '천가동', '대저1동', '대저2동', '명지1동', '명지2동', '녹산동'],
                '금정구': ['금사회동동', '금성동', '남산동', '서동', '부곡동', '장전동', '선동', '청룡노포동', '구서동'],
                '기장군': ['기장읍', '장안읍', '정관읍', '일광면', '철마면'],
                '남구': ['대연동', '용호동', '용당동', '감만동', '우암동', '문현동'],
                '동구': ['초량동', '수정동', '좌천동', '범일동', '범천동', '화양동'],
                '동래구': ['복천동', '수안동', '명륜동', '온천동', '사직동', '안락동', '명장동'],
                '부산진구': ['부전동', '연지동', '초읍동', '양정동', '전포동', '부암동', '당감동', '가야동', '개금동', '범천동'],
                '북구': ['구포동', '금곡동', '화명동', '덕천동', '만덕동'],
                '사상구': ['삼락동', '모라동', '덕포동', '괘법동', '감전동', '주례동', '학장동', '엄궁동'],
                '사하구': ['괴정동', '당리동', '하단동', '신평동', '장림동', '다대동'],
                '서구': ['동대신동', '서대신동', '부민동', '아미동', '초장동', '충무동', '남부민동', '암남동'],
                '수영구': ['남천동', '수영동', '망미동', '광안동', '민락동'],
                '연제구': ['거제동', '연산동'],
                '영도구': ['남항동', '영선동', '신선동', '봉래동', '청학동', '동삼동'],
                '중구': ['중앙동', '동광동', '대청동', '보수동', '부평동', '광복동', '남포동', '영주동'],
                '해운대구': ['우동', '중동', '좌동', '송정동', '재송동', '반여동', '반송동']
            },
            '대구광역시': {
                '남구': ['대명동', '봉덕동', '이천동'],
                '달서구': ['두류동', '성당동', '월성동', '진천동', '상인동', '도원동', '대곡동', '대천동'],
                '달성군': ['화원읍', '논공읍', '다사읍', '유가읍', '옥포읍', '현풍읍', '가창면', '하빈면', '구지면'],
                '동구': ['신암동', '신천동', '효목동', '도평동', '불로봉무동', '지저동', '방촌동', '해안동', '안심동'],
                '북구': ['고성동', '칠성동', '침산동', '산격동', '대현동', '복현동', '검단동', '무태조야동', '관문동', '태전동', '구암동', '관음동', '읍내동', '동변동', '서변동', '금호동', '동천동', '국우동'],
                '서구': ['내당동', '비산동', '평리동', '상리동'],
                '수성구': ['범어동', '만촌동', '수성동', '황금동', '중동', '상동', '파동', '두산동', '지산동', '범물동', '매호동', '고산동', '시지동', '사월동'],
                '중구': ['동인동', '삼덕동', '성내동', '대신동', '남산동', '대봉동', '봉산동']
            },
            '인천광역시': {
                '강화군': ['강화읍', '선원면', '불은면', '길상면', '화도면', '양도면', '내가면', '하점면', '양사면', '송해면', '교동면', '삼산면'],
                '계양구': ['계산동', '작전동', '서운동', '임학동', '동양동', '효성동', '병방동', '용종동', '귀빈동'],
                '남동구': ['구월동', '간석동', '만수동', '장수동', '서창동', '운연동', '남촌동', '수산동', '도림동', '논현동', '고잔동'],
                '동구': ['만석동', '화수동', '송현동', '송림동', '금곡동', '창영동', '화평동'],
                '미추홀구': ['숭의동', '용현동', '학익동', '도화동', '주안동', '관교동', '문학동'],
                '부평구': ['부평동', '산곡동', '청천동', '십정동', '갈산동', '삼산동', '부개동', '일신동'],
                '서구': ['가좌동', '가정동', '석남동', '연희동', '심곡동', '검암동', '경서동', '공촌동', '원창동', '당하동', '불로동', '마전동', '금곡동', '오류동', '왕길동', '검단동'],
                '연수구': ['옥련동', '선학동', '청학동', '동춘동', '송도동'],
                '옹진군': ['북도면', '백령면', '대청면', '덕적면', '자월면', '영흥면', '연평면'],
                '중구': ['신흥동', '선화동', '중앙동', '해안동', '답동', '신생동', '송월동', '송학동', '북성동', '용유동', '을왕동', '무의동', '덕교동', '도원동', '율목동']
            },
            '광주광역시': {
                '광산구': ['송정동', '도산동', '신가동', '지죽동', '도호동', '평동', '삼도동', '본량동', '신창동', '장수동', '운남동', '선암동', '월곡동', '소촌동', '우산동', '동곡동', '비아동', '신촌동', '하남동', '임곡동', '산월동', '내산동', '왕동'],
                '남구': ['양림동', '방림동', '봉선동', '구동', '서동', '월산동', '백운동', '주월동', '노대동', '진월동', '사직동', '이장동', '압촌동', '대촌동', '칠석동', '송하동', '효덕동', '행암동', '양과동', '도금동', '승촌동', '지석동', '임암동'],
                '동구': ['동명동', '계림동', '산수동', '지산동', '황금동', '불로동', '용산동', '소태동', '금남동', '충장동', '대의동', '학동', '남동', '서석동', '궁동', '남동'],
                '북구': ['중흥동', '용봉동', '동림동', '운암동', '우산동', '풍향동', '문화동', '충효동', '신안동', '두암동', '오치동', '삼각동', '매곡동', '석곡동', '건국동', '임동', '신용동', '지야동', '월출동', '덕의동', '태령동', '본촌동', '연제동', '양산동', '장등동', '복룡동', '용두동', '화암동', '효령동', '일곡동', '수곡동'],
                '서구': ['농성동', '광천동', '유덕동', '양동', '치평동', '쌍촌동', '상무동', '내방동', '마륵동', '벽진동', '금호동', '풍암동', '화정동']
            },
            '대전광역시': {
                '대덕구': ['오정동', '대화동', '회덕동', '비래동', '송촌동', '중리동', '법동', '덕암동', '목상동', '석봉동', '신일동', '삼정동', '문평동', '상서동', '이현동', '와동', '갈전동', '신탄진동', '읍내동', '장동', '미호동'],
                '동구': ['중동', '신인동', '판암동', '용운동', '대동', '자양동', '가양동', '효동', '삼성동', '사성동', '가오동', '정동', '인동', '효평동', '용전동', '성남동', '홍도동', '대별동', '마산동', '구도동', '소제동', '오동', '세천동', '신상동', '신하동', '신촌동', '비룡동', '추동'],
                '서구': ['복수동', '도마동', '정림동', '변동', '용문동', '탄방동', '둔산동', '월평동', '갈마동', '관저동', '괴정동', '가장동', '내동', '도안동', '평촌동'],
                '유성구': ['진잠동', '학하동', '온천동', '노은동', '신성동', '전민동', '구즉동', '원신흥동', '관평동', '구암동', '덕진동', '자운동', '장동', '도룡동', '반석동', '교촌동'],
                '중구': ['은행동', '선화동', '목동', '중촌동', '대흥동', '문창동', '석교동', '대사동', '부사동', '유천동', '문화동', '산성동', '사정동', '오류동', '태평동', '용두동', '옥계동', '정생동', '무수동', '호동', '금동', '안영동', '수침동', '침산동', '태평동', '유천동']
            },
            '울산광역시': {
                '남구': ['삼산동', '달동', '신정동', '옥동', '무거동', '삼호동', '야음동', '선암동', '두왕동'],
                '동구': ['화정동', '전하동', '일산동', '서부동', '방어동', '주전동', '명촌동', '대송동', '남목동', '미포동'],
                '북구': ['농소동', '염포동', '화봉동', '효문동', '송정동', '산하동', '양정동', '신현동', '명촌동', '달천동', '천곡동', '중산동', '무룡동', '매곡동', '당사동', '호계동', '정자동', '신명동', '창평동', '진장동', '산하동', '어물동', '이화동'],
                '울주군': ['온산읍', '온양읍', '언양읍', '삼남읍', '청량읍', '범서읍', '삼동면', '두동면', '두서면', '상북면', '서생면', '웅촌면'],
                '중구': ['성안동', '복산동', '교동', '성남동', '옥교동', '서동', '남외동', '북정동', '태화동', '병영동', '다운동', '약사동', '학성동', '반구동', '우정동', '유곡동', '학산동', '잠홍동']
            },
            '세종특별자치시': {
                '세종시': ['조치원읍', '연기면', '연동면', '부강면', '금남면', '장군면', '연서면', '전의면', '전동면', '소정면', '한솔동', '도담동', '아름동', '종촌동', '고운동', '보람동', '대평동', '새롬동']
            },
            '경기도': {
                '가평군': ['가평읍', '설악면', '청평면', '상면', '조종면', '북면'],
                '고양시': ['덕양구', '일산동구', '일산서구'],
                '과천시': ['중앙동', '갈현동', '문원동', '주암동', '과천동', '막계동', '부림동', '원문동', '별양동'],
                '광명시': ['광명동', '철산동', '하안동'],
                '광주시': ['경안동', '송정동', '오포읍', '초월읍', '곤지암읍', '도척면', '퇴촌면', '남종면', '남한산성면'],
                '구리시': ['교문동', '인창동', '수택동', '아차산동', '갈매동'],
                '군포시': ['산본동', '군포동', '당동', '대야미동', '둔대동', '오금동', '당정동', '속달동', '부곡동', '금정동'],
                '김포시': ['김포동', '사우동', '풍무동', '장기동', '고촌읍', '양촌읍', '대곶면', '월곶면', '하성면', '통진읍'],
                '남양주시': ['와부읍', '진접읍', '화도읍', '진건읍', '오남읍', '퇴계원읍', '별내동', '다산동', '지금동', '수동면', '조안면', '별내면'],
                '동두천시': ['생연동', '중앙동', '보산동', '송내동', '상패동', '상봉암동', '하봉암동'],
                '부천시': ['원미구', '소사구', '오정구'],
                '성남시': ['수정구', '중원구', '분당구'],
                '수원시': ['장안구', '권선구', '팔달구', '영통구'],
                '시흥시': ['대야동', '신천동', '신현동', '은행동', '과림동', '장곡동', '월곶동', '정왕동', '목감동'],
                '안산시': ['상록구', '단원구'],
                '안성시': ['안성동', '원곡면', '삼죽면', '미양면', '대덕면', '보개면', '금광면', '서운면', '죽산면', '일죽면', '고삼면', '양성면', '공도읍'],
                '안양시': ['만안구', '동안구'],
                '양주시': ['양주동', '회천동', '은현면', '남면', '광적면', '장흥면', '백석읍'],
                '양평군': ['양평읍', '강상면', '강하면', '양서면', '옥천면', '서종면', '단월면', '청운면', '용문면', '지평면', '개군면', '양동면'],
                '여주시': ['여주읍', '가남읍', '점동면', '흥천면', '금사면', '산북면', '대신면', '북내면', '강천면'],
                '연천군': ['연천읍', '전곡읍', '군남면', '청산면', '왕징면', '미산면', '백학면', '신서면', '중면'],
                '오산시': ['오산동', '원동', '초평동', '궐동', '세교동', '지곶동', '가수동', '갈곶동', '금암동', '수청동', '청학동', '청호동', '탑동'],
                '용인시': ['처인구', '기흥구', '수지구'],
                '의왕시': ['내손동', '오전동', '고천동', '청계동', '포일동', '초평동', '이동'],
                '의정부시': ['의정부동', '호원동', '장암동', '신곡동', '자금동', '가능동', '녹양동'],
                '이천시': ['이천동', '중리동', '장호원읍', '부발읍', '신둔면', '백사면', '호법면', '마장면', '율면', '대월면', '모가면', '설성면'],
                '파주시': ['문산읍', '파주읍', '법원읍', '조리읍', '탄현면', '광탄면', '파평면', '적성면', '월롱면', '금촌동', '교하동', '운정동'],
                '평택시': ['송탄동', '평택동', '서정동', '신장동', '지산동', '청북읍', '오성면', '진위면', '서탄면', '고덕면', '현덕면', '팽성읍', '안중읍', '포승읍'],
                '포천시': ['소흘읍', '가산면', '신북면', '창수면', '영중면', '일동면', '이동면', '영북면', '관인면', '내촌면', '군내면', '화현면'],
                '하남시': ['신장동', '풍산동', '덕풍동', '춘궁동', '감일동', '감북동', '항동', '초이동', '상산곡동', '하산곡동', '초일동', '미사동', '망월동', '창우동', '천현동', '덕풍동', '교산동'],
                '화성시': ['향남읍', '남양읍', '우정읍', '팔탄면', '장안면', '봉담읍', '마도면', '송산면', '서신면', '양감면', '정남면', '매송면', '비봉면', '병점동', '진안동', '반송동', '기안동', '동탄동', '화산동']
            }
        };
        
        function openHospitalSearch() {
            document.getElementById('hospitalSearchModal').classList.add('active');
            currentSearchMode = 'nearby';
            
            // Initialize region selectors
            initializeRegionSelectors();
            
            // Show nearby search by default
            switchSearchMode('nearby');
        }
        
        function initializeRegionSelectors() {
            const sidoSelect = document.getElementById('sidoSelect');
            sidoSelect.innerHTML = '<option value="">선택하세요</option>';
            
            Object.keys(koreaRegions).forEach(sido => {
                const option = document.createElement('option');
                option.value = sido;
                option.textContent = sido;
                sidoSelect.appendChild(option);
            });
        }
        
        function switchSearchMode(mode) {
            currentSearchMode = mode;
            
            // Update tabs
            document.getElementById('nearbyTab').classList.toggle('active', mode === 'nearby');
            document.getElementById('regionTab').classList.toggle('active', mode === 'region');
            
            // Show/hide content
            document.getElementById('nearbySearchMode').style.display = mode === 'nearby' ? 'block' : 'none';
            document.getElementById('regionSearchMode').style.display = mode === 'region' ? 'block' : 'none';
            
            if (mode === 'nearby') {
                // Start location search
                document.getElementById('locationStatus').style.display = 'block';
                document.getElementById('nearbyResults').style.display = 'none';
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            userCoords = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            
                            reverseGeocode(userCoords.lat, userCoords.lng);
                            findNearbyHospitals(userCoords);
                        },
                        (error) => {
                            document.getElementById('locationStatus').innerHTML = `
                                <div style="font-size: 48px; margin-bottom: 16px;">📍</div>
                                <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px; color: var(--danger);">
                                    위치 정보를 가져올 수 없습니다
                                </div>
                                <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                                    브라우저 설정에서 위치 권한을 허용해주세요.
                                </div>
                            `;
                        }
                    );
                }
            } else {
                // Region search mode - show empty state
                document.getElementById('regionHospitalsList').innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">🗺️</div>
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">
                            지역을 선택해주세요
                        </div>
                        <div style="font-size: 14px;">
                            시/도, 시/군/구, 읍/면/동을 선택하여<br>해당 지역의 동물병원을 찾아보세요
                        </div>
                    </div>
                `;
            }
        }
        
        function updateSigungu() {
            const sido = document.getElementById('sidoSelect').value;
            const sigunguSelect = document.getElementById('sigunguSelect');
            const dongSelect = document.getElementById('dongSelect');
            
            selectedRegion.sido = sido;
            selectedRegion.sigungu = '';
            selectedRegion.dong = '';
            
            sigunguSelect.innerHTML = '<option value="">선택하세요</option>';
            dongSelect.innerHTML = '<option value="">시/군/구를 먼저 선택하세요</option>';
            
            if (sido && koreaRegions[sido]) {
                Object.keys(koreaRegions[sido]).forEach(sigungu => {
                    const option = document.createElement('option');
                    option.value = sigungu;
                    option.textContent = sigungu;
                    sigunguSelect.appendChild(option);
                });
            }
        }
        
        function updateDong() {
            const sido = document.getElementById('sidoSelect').value;
            const sigungu = document.getElementById('sigunguSelect').value;
            const dongSelect = document.getElementById('dongSelect');
            
            selectedRegion.sigungu = sigungu;
            selectedRegion.dong = '';
            
            dongSelect.innerHTML = '<option value="">선택하세요</option>';
            
            if (sido && sigungu && koreaRegions[sido][sigungu]) {
                koreaRegions[sido][sigungu].forEach(dong => {
                    const option = document.createElement('option');
                    option.value = dong;
                    option.textContent = dong;
                    dongSelect.appendChild(option);
                });
            }
        }
        
        function searchByRegion() {
            const sido = document.getElementById('sidoSelect').value;
            const sigungu = document.getElementById('sigunguSelect').value;
            const dong = document.getElementById('dongSelect').value;
            const query = document.getElementById('regionSearchQuery').value.toLowerCase().trim();
            
            selectedRegion = { sido, sigungu, dong };
            
            if (!sido) {
                document.getElementById('regionHospitalsList').innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">🗺️</div>
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">
                            시/도를 선택해주세요
                        </div>
                    </div>
                `;
                return;
            }
            
            // Generate hospitals for selected region
            const regionHospitals = generateRegionHospitals(sido, sigungu, dong);
            
            // Filter by query if exists
            let filtered = regionHospitals;
            if (query) {
                filtered = regionHospitals.filter(hospital => 
                    hospital.name.toLowerCase().includes(query) ||
                    hospital.address.toLowerCase().includes(query)
                );
            }
            
            renderRegionHospitals(filtered);
        }
        
        function generateRegionHospitals(sido, sigungu, dong) {
            const baseAddress = `${sido} ${sigungu}${dong ? ' ' + dong : ''}`;
            
            const hospitals = [
                {
                    name: '24시 종합 동물병원',
                    address: `${baseAddress} 중앙로 123`,
                    phone: '02-1234-5678',
                    rating: 4.8,
                    isOpen: true,
                    hours: '24시간 운영'
                },
                {
                    name: '사랑 동물의료센터',
                    address: `${baseAddress} 평화로 456`,
                    phone: '02-2345-6789',
                    rating: 4.7,
                    isOpen: true,
                    hours: '09:00 - 20:00'
                },
                {
                    name: '우리 동물병원',
                    address: `${baseAddress} 행복길 789`,
                    phone: '02-3456-7890',
                    rating: 4.5,
                    isOpen: false,
                    hours: '09:00 - 18:00 (일요일 휴무)'
                },
                {
                    name: '펫케어 동물병원',
                    address: `${baseAddress} 반려로 321`,
                    phone: '02-4567-8901',
                    rating: 4.6,
                    isOpen: true,
                    hours: '10:00 - 21:00'
                },
                {
                    name: '반려동물 가족병원',
                    address: `${baseAddress} 사랑로 654`,
                    phone: '02-5678-9012',
                    rating: 4.4,
                    isOpen: true,
                    hours: '09:00 - 19:00'
                }
            ];
            
            return hospitals;
        }
        
        function renderRegionHospitals(hospitals) {
            const container = document.getElementById('regionHospitalsList');
            
            if (hospitals.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">🔍</div>
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">
                            검색 결과가 없습니다
                        </div>
                        <div style="font-size: 14px;">
                            다른 지역을 선택하거나 검색어를 변경해보세요
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = hospitals.map(hospital => `
                <div class="hospital-card" onclick="selectHospital('${hospital.name}')">
                    <div class="hospital-header">
                        <div>
                            <div class="hospital-name">${hospital.name}</div>
                            <div class="hospital-info">⭐ ${hospital.rating}</div>
                        </div>
                    </div>
                    <div class="hospital-info">📍 ${hospital.address}</div>
                    <div class="hospital-info">📞 ${hospital.phone}</div>
                    <div class="hospital-info">🕒 ${hospital.hours}</div>
                    <div class="hospital-status ${hospital.isOpen ? 'status-open' : 'status-closed'}">
                        ${hospital.isOpen ? '영업 중' : '영업 종료'}
                    </div>
                    <div class="hospital-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); callHospital('${hospital.phone}')">
                            📞 전화
                        </button>
                        <button class="action-btn" onclick="event.stopPropagation(); searchMapLocation('${hospital.address}')">
                            🗺️ 지도
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function reverseGeocode(lat, lng) {
            document.getElementById('userLocation').textContent = `위도 ${lat.toFixed(4)}, 경도 ${lng.toFixed(4)}`;
        }
        
        function findNearbyHospitals(coords) {
            nearbyHospitals = generateMockHospitals(coords);
            allHospitals = [...nearbyHospitals];
            
            setTimeout(() => {
                document.getElementById('locationStatus').style.display = 'none';
                document.getElementById('nearbyResults').style.display = 'block';
                renderHospitals(nearbyHospitals);
            }, 1500);
        }
        
        function generateMockHospitals(coords) {
            const hospitals = [
                {
                    name: '사랑동물병원',
                    address: '부산광역시 해운대구 센텀중앙로 78',
                    phone: '051-123-4567',
                    distance: 0.5,
                    rating: 4.8,
                    isOpen: true,
                    hours: '09:00 - 20:00',
                    lat: coords.lat + 0.005,
                    lng: coords.lng + 0.005
                },
                {
                    name: '24시 해운대 동물의료센터',
                    address: '부산광역시 해운대구 해운대로 567',
                    phone: '051-234-5678',
                    distance: 1.2,
                    rating: 4.6,
                    isOpen: true,
                    hours: '24시간 운영',
                    lat: coords.lat + 0.008,
                    lng: coords.lng - 0.003
                },
                {
                    name: '우리들 동물병원',
                    address: '부산광역시 해운대구 좌동순환로 345',
                    phone: '051-345-6789',
                    distance: 1.8,
                    rating: 4.5,
                    isOpen: false,
                    hours: '09:00 - 18:00 (일요일 휴무)',
                    lat: coords.lat - 0.012,
                    lng: coords.lng + 0.008
                },
                {
                    name: '반려동물 종합병원',
                    address: '부산광역시 해운대구 마린시티1로 89',
                    phone: '051-456-7890',
                    distance: 2.3,
                    rating: 4.7,
                    isOpen: true,
                    hours: '09:00 - 21:00',
                    lat: coords.lat + 0.015,
                    lng: coords.lng - 0.01
                },
                {
                    name: '펫케어 동물병원',
                    address: '부산광역시 수영구 광안해변로 234',
                    phone: '051-567-8901',
                    distance: 3.1,
                    rating: 4.4,
                    isOpen: true,
                    hours: '10:00 - 19:00',
                    lat: coords.lat - 0.02,
                    lng: coords.lng + 0.015
                },
                {
                    name: '해피펫 동물병원',
                    address: '부산광역시 해운대구 좌동 678',
                    phone: '051-678-9012',
                    distance: 4.2,
                    rating: 4.3,
                    isOpen: true,
                    hours: '09:00 - 19:00',
                    lat: coords.lat + 0.025,
                    lng: coords.lng + 0.02
                },
                {
                    name: '센텀 동물의료센터',
                    address: '부산광역시 해운대구 센텀남대로 432',
                    phone: '051-789-0123',
                    distance: 5.5,
                    rating: 4.9,
                    isOpen: true,
                    hours: '24시간 운영',
                    lat: coords.lat - 0.03,
                    lng: coords.lng - 0.025
                }
            ];
            
            return hospitals;
        }
        
        function filterByDistance() {
            const maxDistance = parseFloat(document.getElementById('distanceFilter').value);
            const filtered = allHospitals.filter(h => h.distance <= maxDistance);
            renderHospitals(filtered);
        }
        
        function renderHospitals(hospitals) {
            const container = document.getElementById('hospitalsList');
            
            if (hospitals.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">🔍</div>
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">
                            검색 결과가 없습니다
                        </div>
                        <div style="font-size: 14px;">
                            거리 필터를 조정하거나 다른 검색어로 시도해보세요
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = hospitals.map(hospital => `
                <div class="hospital-card" onclick="selectHospital('${hospital.name}')">
                    <div class="hospital-header">
                        <div>
                            <div class="hospital-name">${hospital.name}</div>
                            <div class="hospital-info">⭐ ${hospital.rating}</div>
                        </div>
                        <div class="hospital-distance">${hospital.distance}km</div>
                    </div>
                    <div class="hospital-info">📍 ${hospital.address}</div>
                    <div class="hospital-info">📞 ${hospital.phone}</div>
                    <div class="hospital-info">🕒 ${hospital.hours}</div>
                    <div class="hospital-status ${hospital.isOpen ? 'status-open' : 'status-closed'}">
                        ${hospital.isOpen ? '영업 중' : '영업 종료'}
                    </div>
                    <div class="hospital-actions">
                        <button class="action-btn" onclick="event.stopPropagation(); callHospital('${hospital.phone}')">
                            📞 전화
                        </button>
                        <button class="action-btn" onclick="event.stopPropagation(); getDirections(${hospital.lat}, ${hospital.lng})">
                            🗺️ 길찾기
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function searchHospitals() {
            const query = document.getElementById('searchQuery').value.toLowerCase().trim();
            
            if (!query) {
                filterByDistance();
                return;
            }
            
            const maxDistance = parseFloat(document.getElementById('distanceFilter').value);
            const filtered = allHospitals.filter(hospital => 
                hospital.distance <= maxDistance &&
                (hospital.name.toLowerCase().includes(query) ||
                hospital.address.toLowerCase().includes(query))
            );
            
            renderHospitals(filtered);
        }
        
        function selectHospital(name) {
            console.log('Selected hospital:', name);
        }
        
        function callHospital(phone) {
            window.location.href = `tel:${phone.replace(/-/g, '')}`;
        }
        
        function getDirections(lat, lng) {
            if (userCoords) {
                const url = `https://www.google.com/maps/dir/?api=1&origin=${userCoords.lat},${userCoords.lng}&destination=${lat},${lng}&travelmode=driving`;
                window.open(url, '_blank');
            } else {
                const url = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                window.open(url, '_blank');
            }
        }
        
        function searchMapLocation(address) {
            const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
            window.open(url, '_blank');
        }
        
        function switchTab(tab) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Hide all pages
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('albumPage').style.display = 'none';
            document.getElementById('mealPage').style.display = 'none';
            document.getElementById('recordsPage').style.display = 'none';
            document.getElementById('recordsDetailPage').style.display = 'none';
            document.getElementById('settingsPage').style.display = 'none';
            
            // Show selected page
            if (tab === 'home') {
                document.querySelectorAll('.nav-item')[0].classList.add('active');
                document.getElementById('homePage').style.display = 'block';
            } else if (tab === 'album') {
                document.querySelectorAll('.nav-item')[1].classList.add('active');
                document.getElementById('albumPage').style.display = 'block';
                populatePetSelector('albumPetSelect');
                renderPhotosPage();
            } else if (tab === 'meal') {
                document.querySelectorAll('.nav-item')[2].classList.add('active');
                document.getElementById('mealPage').style.display = 'block';
                populatePetSelector('mealPetSelect');
                updateMealSummaryPage();
                renderMealsPage();
            } else if (tab === 'hospital') {
                document.querySelectorAll('.nav-item')[3].classList.add('active');
                openHospitalSearch();
            } else if (tab === 'settings') {
                document.querySelectorAll('.nav-item')[4].classList.add('active');
                document.getElementById('settingsPage').style.display = 'block';
                renderSettings();
            }
        }
        
        function populatePetSelector(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            select.innerHTML = '<option value="">반려동물 선택...</option>';
            
            appData.pets.forEach(pet => {
                const emoji = pet.type === '강아지' ? '🐕' : pet.type === '고양이' ? '🐈' : '🐾';
                const option = document.createElement('option');
                option.value = pet.id;
                option.textContent = `${emoji} ${pet.name}`;
                if (pet.id === appData.currentPetId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }
        
        function switchPetFromPage(page, petId) {
            if (!petId) return;
            
            appData.currentPetId = parseInt(petId);
            saveData();
            
            // Update the page content
            if (page === 'album') {
                renderPhotosPage();
            } else if (page === 'meal') {
                updateMealSummaryPage();
                renderMealsPage();
            }
            
            // Also update home page if needed
            renderPets();
        }
        
        // Records Page Functions
        let currentFilter = 'all';
        let currentDetailType = null;
        
        function viewRecordsByType(type) {
            // Track type for add button
            currentDetailType = type;
            
            // Track where we came from
            const currentPage = document.getElementById('homePage').style.display === 'block' ? 'home' :
                              document.getElementById('albumPage').style.display === 'block' ? 'album' :
                              document.getElementById('mealPage').style.display === 'block' ? 'meal' : 'home';
            
            if (currentPage) {
                navigationHistory.push(currentPage);
            }
            
            // Hide all pages
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('albumPage').style.display = 'none';
            document.getElementById('mealPage').style.display = 'none';
            document.getElementById('recordsPage').style.display = 'none';
            document.getElementById('recordsDetailPage').style.display = 'block';
            document.getElementById('settingsPage').style.display = 'none';
            
            // Update nav (no active tab since this is a detail page)
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Set title and render
            if (type === 'vaccination') {
                document.getElementById('recordsDetailTitle').textContent = '💉 예방접종 기록';
                document.getElementById('recordsDetailSubtitle').textContent = '모든 예방접종 기록을 확인하세요';
            } else if (type === 'medication') {
                document.getElementById('recordsDetailTitle').textContent = '💊 투약 기록';
                document.getElementById('recordsDetailSubtitle').textContent = '모든 투약 기록을 확인하세요';
            } else if (type === 'hospital') {
                document.getElementById('recordsDetailTitle').textContent = '🏥 병원 기록';
                document.getElementById('recordsDetailSubtitle').textContent = '모든 병원 방문 기록을 확인하세요';
            }
            
            renderRecordsDetail(type);
        }
        
        function renderRecordsDetail(type) {
            const container = document.getElementById('recordsDetailList');
            
            let records = [];
            const pet = appData.pets.find(p => p.id === appData.currentPetId);
            const petEmoji = pet ? (pet.type === '강아지' ? '🐕' : pet.type === '고양이' ? '🐈' : '🐾') : '🐾';
            const petName = pet ? pet.name : '알 수 없음';
            
            if (type === 'vaccination') {
                records = appData.vaccinations
                    .filter(v => v.petId === appData.currentPetId)
                    .map(v => ({
                        ...v,
                        type: 'vaccination',
                        petName,
                        emoji: petEmoji
                    }));
            } else if (type === 'medication') {
                records = appData.medications
                    .filter(m => m.petId === appData.currentPetId)
                    .map(m => ({
                        ...m,
                        type: 'medication',
                        petName,
                        emoji: petEmoji
                    }));
            } else if (type === 'hospital') {
                records = appData.hospitals
                    .filter(h => h.petId === appData.currentPetId)
                    .map(h => ({
                        ...h,
                        type: 'hospital',
                        petName,
                        emoji: petEmoji
                    }));
            }
            
            records.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (records.length === 0) {
                container.innerHTML = `
                    <div class="section">
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">기록이 없습니다</div>
                            <div style="font-size: 14px;">새로운 기록을 추가해보세요</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = records.map(record => {
                const typeClass = record.type;
                
                return `
                    <div class="record-item ${typeClass}" style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">${record.emoji}</span>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 2px;">${record.petName}</div>
                                    <div class="record-title">${record.name}</div>
                                </div>
                            </div>
                            <div class="record-date">${formatDate(record.date)}</div>
                        </div>
                        ${record.notes ? `<div class="record-detail">${record.notes}</div>` : ''}
                        ${record.nextDate ? `<div class="next-date">다음: ${formatDate(record.nextDate)}</div>` : ''}
                        ${record.frequency ? `<div class="record-detail">복용 주기: ${record.frequency}</div>` : ''}
                        ${record.cost ? `<div class="record-detail">비용: ${parseInt(record.cost).toLocaleString()}원</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function filterRecords(type) {
            currentFilter = type;
            
            // Update filter tabs
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderAllRecords();
        }
        
        function renderAllRecords() {
            const container = document.getElementById('allRecordsList');
            
            // Combine all records
            let allRecords = [];
            
            appData.vaccinations.forEach(v => {
                const pet = appData.pets.find(p => p.id === v.petId);
                allRecords.push({
                    ...v,
                    type: 'vaccination',
                    petName: pet ? pet.name : '알 수 없음',
                    emoji: pet ? (pet.type === '강아지' ? '🐕' : pet.type === '고양이' ? '🐈' : '🐾') : '🐾'
                });
            });
            
            appData.medications.forEach(m => {
                const pet = appData.pets.find(p => p.id === m.petId);
                allRecords.push({
                    ...m,
                    type: 'medication',
                    petName: pet ? pet.name : '알 수 없음',
                    emoji: pet ? (pet.type === '강아지' ? '🐕' : pet.type === '고양이' ? '🐈' : '🐾') : '🐾'
                });
            });
            
            appData.hospitals.forEach(h => {
                const pet = appData.pets.find(p => p.id === h.petId);
                allRecords.push({
                    ...h,
                    type: 'hospital',
                    petName: pet ? pet.name : '알 수 없음',
                    emoji: pet ? (pet.type === '강아지' ? '🐕' : pet.type === '고양이' ? '🐈' : '🐾') : '🐾'
                });
            });
            
            // Filter by type
            if (currentFilter !== 'all') {
                allRecords = allRecords.filter(r => r.type === currentFilter);
            }
            
            // Sort by date
            allRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allRecords.length === 0) {
                container.innerHTML = `
                    <div class="section">
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">기록이 없습니다</div>
                            <div style="font-size: 14px;">반려동물의 건강 정보를 추가해보세요</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allRecords.map(record => {
                const typeLabel = record.type === 'vaccination' ? '💉 예방접종' :
                                record.type === 'medication' ? '💊 투약' : '🏥 병원';
                const typeClass = record.type;
                
                return `
                    <div class="record-item ${typeClass}" style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">${record.emoji}</span>
                                <div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 2px;">${typeLabel} · ${record.petName}</div>
                                    <div class="record-title">${record.name}</div>
                                </div>
                            </div>
                            <div class="record-date">${formatDate(record.date)}</div>
                        </div>
                        ${record.notes ? `<div class="record-detail">${record.notes}</div>` : ''}
                        ${record.nextDate ? `<div class="next-date">다음: ${formatDate(record.nextDate)}</div>` : ''}
                        ${record.frequency ? `<div class="record-detail">복용 주기: ${record.frequency}</div>` : ''}
                        ${record.cost ? `<div class="record-detail">비용: ${parseInt(record.cost).toLocaleString()}원</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Settings Page Functions
        function renderSettings() {
            const container = document.getElementById('petManagementList');
            
            // Update trash count
            updateTrashCount();
            
            // Update premium status display
            const isPremium = appData.isPremium && (!appData.premiumExpiry || new Date(appData.premiumExpiry) > new Date());
            
            if (isPremium) {
                document.getElementById('premiumBannerSettings').style.display = 'none';
                document.getElementById('premiumStatusSettings').style.display = 'block';
                
                // Show next billing date and period
                const expiryDate = new Date(appData.premiumExpiry);
                const periodText = appData.subscriptionPeriod === 'yearly' ? '연간 구독' : '월간 구독';
                document.getElementById('nextBillingDate').textContent = expiryDate.toLocaleDateString('ko-KR') + ` (${periodText})`;
            } else {
                document.getElementById('premiumBannerSettings').style.display = 'block';
                document.getElementById('premiumStatusSettings').style.display = 'none';
            }
            
            if (appData.pets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 30px 20px;">
                        <div style="font-size: 14px; color: var(--text-secondary);">등록된 반려동물이 없습니다</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = appData.pets.map(pet => {
                const emoji = pet.type === '강아지' ? '🐕' : pet.type === '고양이' ? '🐈' : '🐾';
                const age = pet.birthday ? calculateAge(pet.birthday) : '';
                
                return `
                    <div class="pet-manage-card">
                        <div class="pet-manage-avatar">${emoji}</div>
                        <div class="pet-manage-info">
                            <div class="pet-manage-name">${pet.name}</div>
                            <div class="pet-manage-details">
                                ${pet.breed || pet.type}${age ? ' · ' + age : ''}${pet.weight ? ' · ' + pet.weight + 'kg' : ''}
                            </div>
                        </div>
                        <div class="pet-manage-actions">
                            <button class="icon-button" onclick="editPet(${pet.id})" title="수정">✏️</button>
                            <button class="icon-button danger" onclick="deletePet(${pet.id})" title="삭제">🗑️</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function editPet(petId) {
            const pet = appData.pets.find(p => p.id === petId);
            if (!pet) return;
            
            document.getElementById('petName').value = pet.name;
            document.getElementById('petType').value = pet.type;
            document.getElementById('petBreed').value = pet.breed || '';
            document.getElementById('petBirthday').value = pet.birthday || '';
            document.getElementById('petWeight').value = pet.weight || '';
            
            // Change form to edit mode
            const form = document.getElementById('addPetForm');
            form.onsubmit = (e) => {
                e.preventDefault();
                
                pet.name = document.getElementById('petName').value;
                pet.type = document.getElementById('petType').value;
                pet.breed = document.getElementById('petBreed').value;
                pet.birthday = document.getElementById('petBirthday').value;
                pet.weight = document.getElementById('petWeight').value;
                
                saveData();
                renderPets();
                renderSettings();
                closeModal('addPetModal');
                
                // Reset form handler
                form.onsubmit = handleAddPet;
            };
            
            openAddPetModal();
        }
        
        function deletePet(petId) {
            const pet = appData.pets.find(p => p.id === petId);
            if (!pet) return;
            
            if (!confirm(`${pet.name}을(를) 삭제하시겠습니까?\n\n삭제된 반려동물은 30일 동안 휴지통에 보관됩니다.`)) {
                return;
            }
            
            // Initialize trash if not exists
            if (!appData.trash) {
                appData.trash = { pets: [], deletedAt: {} };
            }
            
            // Move to trash
            appData.trash.pets.push({
                pet: pet,
                vaccinations: appData.vaccinations.filter(v => v.petId === petId),
                medications: appData.medications.filter(m => m.petId === petId),
                hospitals: appData.hospitals.filter(h => h.petId === petId),
                photos: appData.photos.filter(p => p.petId === petId),
                meals: appData.meals.filter(m => m.petId === petId)
            });
            
            appData.trash.deletedAt[petId] = new Date().toISOString();
            
            // Remove pet
            appData.pets = appData.pets.filter(p => p.id !== petId);
            
            // Remove related records
            appData.vaccinations = appData.vaccinations.filter(v => v.petId !== petId);
            appData.medications = appData.medications.filter(m => m.petId !== petId);
            appData.hospitals = appData.hospitals.filter(h => h.petId !== petId);
            appData.photos = appData.photos.filter(p => p.petId !== petId);
            appData.meals = appData.meals.filter(m => m.petId !== petId);
            
            // Update current pet
            if (appData.currentPetId === petId) {
                appData.currentPetId = appData.pets.length > 0 ? appData.pets[0].id : null;
            }
            
            saveData();
            renderPets();
            renderSettings();
            showSuccessToast(`${pet.name}이(가) 휴지통으로 이동되었습니다`);
            
            if (appData.pets.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('practicalFeatures').style.display = 'none';
                document.getElementById('vaccinationsSection').style.display = 'none';
                document.getElementById('medicationsSection').style.display = 'none';
                document.getElementById('hospitalSection').style.display = 'none';
                document.getElementById('statsGrid').style.display = 'none';
            } else {
                selectPet(appData.currentPetId);
            }
        }
        
        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `petcare-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('데이터를 성공적으로 내보냈습니다!');
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    if (confirm('기존 데이터를 모두 덮어쓰시겠습니까? (취소하면 기존 데이터에 추가됩니다)')) {
                        appData = imported;
                    } else {
                        // Merge data
                        imported.pets.forEach(pet => {
                            pet.id = Date.now() + Math.random();
                            appData.pets.push(pet);
                        });
                        imported.vaccinations.forEach(v => appData.vaccinations.push(v));
                        imported.medications.forEach(m => appData.medications.push(m));
                        imported.hospitals.forEach(h => appData.hospitals.push(h));
                    }
                    
                    saveData();
                    location.reload();
                } catch (error) {
                    alert('잘못된 파일 형식입니다.');
                }
            };
            reader.readAsText(file);
        }
        
        function confirmDeleteAllData() {
            const confirmed = prompt('모든 데이터를 삭제하려면 "삭제"를 입력하세요:');
            
            if (confirmed === '삭제') {
                localStorage.removeItem('petHealthDiary');
                alert('모든 데이터가 삭제되었습니다.');
                location.reload();
            }
        }
        
        // Store original form handler
        const handleAddPet = document.getElementById('addPetForm').onsubmit;
        
        // ===== GLOBAL SEARCH FUNCTIONS =====
        let searchTimeout;
        
        function handleGlobalSearch(event) {
            clearTimeout(searchTimeout);
            
            const query = event.target.value.trim().toLowerCase();
            
            if (query.length < 2) {
                hideSearchResults();
                return;
            }
            
            // Debounce search
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        }
        
        function performSearch(query) {
            const results = [];
            
            // Search in vaccinations
            appData.vaccinations.forEach(v => {
                const pet = appData.pets.find(p => p.id === v.petId);
                const searchText = `${v.name} ${v.notes || ''} ${v.date}`.toLowerCase();
                
                if (searchText.includes(query)) {
                    results.push({
                        type: 'vaccination',
                        typeLabel: '💉 예방접종',
                        title: v.name,
                        detail: `${pet ? pet.name : '알 수 없음'} · ${formatDate(v.date)}`,
                        date: v.date,
                        data: v
                    });
                }
            });
            
            // Search in medications
            appData.medications.forEach(m => {
                const pet = appData.pets.find(p => p.id === m.petId);
                const searchText = `${m.name} ${m.notes || ''} ${m.date}`.toLowerCase();
                
                if (searchText.includes(query)) {
                    results.push({
                        type: 'medication',
                        typeLabel: '💊 투약',
                        title: m.name,
                        detail: `${pet ? pet.name : '알 수 없음'} · ${formatDate(m.date)}`,
                        date: m.date,
                        data: m
                    });
                }
            });
            
            // Search in hospitals
            appData.hospitals.forEach(h => {
                const pet = appData.pets.find(p => p.id === h.petId);
                const searchText = `${h.name} ${h.notes || ''} ${h.date}`.toLowerCase();
                
                if (searchText.includes(query)) {
                    results.push({
                        type: 'hospital',
                        typeLabel: '🏥 병원',
                        title: h.name,
                        detail: `${pet ? pet.name : '알 수 없음'} · ${formatDate(h.date)}`,
                        date: h.date,
                        data: h
                    });
                }
            });
            
            // Search in meals
            appData.meals.forEach(m => {
                const pet = appData.pets.find(p => p.id === m.petId);
                const searchText = `${m.name || m.type} ${m.notes || ''} ${m.time}`.toLowerCase();
                
                if (searchText.includes(query)) {
                    results.push({
                        type: 'meal',
                        typeLabel: '🍖 식단',
                        title: m.name || m.type,
                        detail: `${pet ? pet.name : '알 수 없음'} · ${new Date(m.time).toLocaleDateString('ko-KR')}`,
                        date: m.time,
                        data: m
                    });
                }
            });
            
            // Sort by date (newest first)
            results.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            displaySearchResults(results, query);
        }
        
        function displaySearchResults(results, query) {
            const container = document.getElementById('searchResultsContainer');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div style="padding: 24px; text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 32px; margin-bottom: 8px;">🔍</div>
                        <div>검색 결과가 없습니다</div>
                    </div>
                `;
                container.style.display = 'block';
                return;
            }
            
            // Highlight search term
            const highlightText = (text) => {
                const regex = new RegExp(`(${query})`, 'gi');
                return text.replace(regex, '<span class="search-highlight">$1</span>');
            };
            
            container.innerHTML = results.slice(0, 10).map(result => `
                <div class="search-result-item" onclick="jumpToRecord('${result.type}', ${result.data.id})">
                    <div class="search-result-type">${result.typeLabel}</div>
                    <div class="search-result-title">${highlightText(result.title)}</div>
                    <div class="search-result-detail">${result.detail}</div>
                </div>
            `).join('');
            
            if (results.length > 10) {
                container.innerHTML += `
                    <div style="padding: 12px; text-align: center; color: var(--text-secondary); font-size: 13px;">
                        ${results.length - 10}개 더 있음
                    </div>
                `;
            }
            
            container.style.display = 'block';
        }
        
        function showSearchResults() {
            const query = document.getElementById('globalSearch').value.trim().toLowerCase();
            if (query.length >= 2) {
                performSearch(query);
            }
        }
        
        function hideSearchResults() {
            const container = document.getElementById('searchResultsContainer');
            container.style.display = 'none';
        }
        
        function hideSearchResultsDelayed() {
            setTimeout(() => {
                hideSearchResults();
            }, 200);
        }
        
        function jumpToRecord(type, id) {
            hideSearchResults();
            document.getElementById('globalSearch').value = '';
            
            // Navigate to appropriate page and highlight record
            if (type === 'vaccination' || type === 'medication' || type === 'hospital') {
                viewRecordsByType(type);
            } else if (type === 'meal') {
                switchTab('meal');
            }
        }
        
        // ===== LOADING TOAST UTILITY =====
        function showLoadingToast(message) {
            const existingToast = document.getElementById('globalLoadingToast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.id = 'globalLoadingToast';
            toast.dataset.startTime = Date.now(); // Track start time
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.9);
                color: white;
                padding: 14px 28px;
                border-radius: 10px;
                z-index: 10000;
                font-size: 14px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            const spinner = document.createElement('div');
            spinner.style.cssText = `
                width: 16px;
                height: 16px;
                border: 2px solid rgba(255,255,255,0.3);
                border-top-color: white;
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            `;
            
            toast.appendChild(spinner);
            toast.appendChild(document.createTextNode(message));
            document.body.appendChild(toast);
            
            return toast;
        }
        
        function hideLoadingToast() {
            const toast = document.getElementById('globalLoadingToast');
            if (toast) toast.remove();
        }
        
        function showSuccessToast(message) {
            const loadingToast = document.getElementById('globalLoadingToast');
            const minDisplayTime = 500; // minimum 500ms
            
            const showSuccess = () => {
                if (loadingToast) loadingToast.remove();
                
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    color: white;
                    padding: 14px 28px;
                    border-radius: 10px;
                    z-index: 10000;
                    font-size: 14px;
                    font-weight: 600;
                    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
                `;
                toast.textContent = `✓ ${message}`;
                document.body.appendChild(toast);
                
                setTimeout(() => toast.remove(), 2000);
            };
            
            if (loadingToast && loadingToast.dataset.startTime) {
                const elapsed = Date.now() - parseInt(loadingToast.dataset.startTime);
                const remaining = Math.max(0, minDisplayTime - elapsed);
                
                setTimeout(showSuccess, remaining);
            } else {
                showSuccess();
            }
        }
        
        // Add spin animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
        
        // ===== IMAGE COMPRESSION UTILITY =====
        function compressImage(file, maxWidth = 1200, maxHeight = 1200, quality = 0.85) {
            return new Promise((resolve, reject) => {
                // Check file size
                const fileSizeMB = file.size / (1024 * 1024);
                if (fileSizeMB > 10) {
                    reject(new Error('파일이 너무 큽니다 (10MB 초과)'));
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        // Calculate new dimensions (increased for better quality)
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round((height * maxWidth) / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round((width * maxHeight) / height);
                                height = maxHeight;
                            }
                        }
                        
                        // Create canvas and compress
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        // Better quality rendering
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to compressed base64
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        
                        // Check compressed size
                        const compressedSize = compressedDataUrl.length * 0.75 / 1024; // KB
                        console.log(`Original: ${fileSizeMB.toFixed(2)}MB → Compressed: ${compressedSize.toFixed(2)}KB`);
                        
                        resolve(compressedDataUrl);
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
        
        // ===== PHOTO GALLERY FUNCTIONS =====
        let currentPhotoIndex = 0;
        
        // Modal version
        function openPhotoGallery() {
            if (!appData.currentPetId) {
                alert('먼저 반려동물을 선택해주세요!');
                return;
            }
            document.getElementById('photoGalleryModal').classList.add('active');
            renderPhotos();
        }
        
        function renderPhotos() {
            const petPhotos = appData.photos.filter(p => p.petId === appData.currentPetId);
            const grid = document.getElementById('photoGrid');
            const emptyState = document.getElementById('emptyPhotos');
            
            document.getElementById('photoCount').textContent = petPhotos.length;
            
            if (petPhotos.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            grid.innerHTML = petPhotos.sort((a, b) => new Date(b.date) - new Date(a.date)).map((photo, index) => `
                <div class="photo-item" onclick="viewPhotoDetail(${index})">
                    <img src="${photo.data}" alt="photo">
                    <div class="photo-date">${new Date(photo.date).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })}</div>
                </div>
            `).join('');
        }
        
        // Page version
        function renderPhotosPage() {
            if (!appData.currentPetId) {
                document.getElementById('photoGridPage').style.display = 'none';
                document.getElementById('emptyPhotosPage').innerHTML = `
                    <div class="empty-state-icon">🐕</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">반려동물을 선택해주세요</div>
                    <div style="font-size: 14px;">홈 화면에서 반려동물을 선택하거나 추가하세요</div>
                `;
                document.getElementById('emptyPhotosPage').style.display = 'block';
                return;
            }
            
            const petPhotos = appData.photos.filter(p => p.petId === appData.currentPetId);
            const grid = document.getElementById('photoGridPage');
            const emptyState = document.getElementById('emptyPhotosPage');
            
            document.getElementById('photoCountPage').textContent = petPhotos.length;
            
            if (petPhotos.length === 0) {
                grid.style.display = 'none';
                emptyState.innerHTML = `
                    <div class="empty-state-icon">📷</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">아직 사진이 없어요</div>
                    <div style="font-size: 14px;">소중한 순간을 기록해보세요!</div>
                `;
                emptyState.style.display = 'block';
                return;
            }
            
            grid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            grid.innerHTML = petPhotos.sort((a, b) => new Date(b.date) - new Date(a.date)).map((photo, index) => `
                <div class="photo-item" onclick="viewPhotoDetail(${index})">
                    <img src="${photo.data}" alt="photo">
                    <div class="photo-date">${new Date(photo.date).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })}</div>
                </div>
            `).join('');
        }
        
        function handlePhotoAdd(event) {
            const files = Array.from(event.target.files);
            
            // Check storage before upload
            const storageCheck = checkStorageSpace();
            if (!storageCheck.hasSpace) {
                alert(`저장 공간이 부족합니다!\n\n현재 사용량: ${storageCheck.usedPercent}%\n일부 사진을 삭제해주세요.`);
                return;
            }
            
            if (storageCheck.usedPercent > 70) {
                if (!confirm(`저장 공간이 ${storageCheck.usedPercent}% 사용되었습니다.\n계속 진행하시겠습니까?`)) {
                    return;
                }
            }
            
            let processed = 0;
            let failed = 0;
            
            showLoadingToast(`사진 압축 중... (0/${files.length})`);
            
            files.forEach((file, index) => {
                compressImage(file).then(compressedData => {
                    appData.photos.push({
                        id: Date.now() + processed,
                        petId: appData.currentPetId,
                        data: compressedData,
                        date: new Date().toISOString(),
                        memo: ''
                    });
                    processed++;
                    
                    const toast = document.getElementById('globalLoadingToast');
                    if (toast) {
                        toast.childNodes[1].textContent = `사진 압축 중... (${processed}/${files.length})`;
                    }
                    
                    if (processed + failed === files.length) {
                        saveData();
                        renderPhotos();
                        if (failed > 0) {
                            showSuccessToast(`${processed}개 추가됨 (${failed}개 실패)`);
                        } else {
                            showSuccessToast('사진이 추가되었습니다');
                        }
                    }
                }).catch(err => {
                    console.error('Image compression failed:', err);
                    failed++;
                    if (processed + failed === files.length) {
                        hideLoadingToast();
                        if (processed > 0) {
                            saveData();
                            renderPhotos();
                            showSuccessToast(`${processed}개 추가됨 (${failed}개 실패)`);
                        } else {
                            alert(`사진 업로드 실패: ${err.message}`);
                        }
                    }
                });
            });
        }
        
        function handlePhotoAddPage(event) {
            const files = Array.from(event.target.files);
            
            // Check storage before upload
            const storageCheck = checkStorageSpace();
            if (!storageCheck.hasSpace) {
                alert(`저장 공간이 부족합니다!\n\n현재 사용량: ${storageCheck.usedPercent}%\n일부 사진을 삭제해주세요.`);
                return;
            }
            
            if (storageCheck.usedPercent > 70) {
                if (!confirm(`저장 공간이 ${storageCheck.usedPercent}% 사용되었습니다.\n계속 진행하시겠습니까?`)) {
                    return;
                }
            }
            
            let processed = 0;
            let failed = 0;
            
            showLoadingToast(`사진 압축 중... (0/${files.length})`);
            
            files.forEach((file, index) => {
                compressImage(file).then(compressedData => {
                    appData.photos.push({
                        id: Date.now() + processed,
                        petId: appData.currentPetId,
                        data: compressedData,
                        date: new Date().toISOString(),
                        memo: ''
                    });
                    processed++;
                    
                    const toast = document.getElementById('globalLoadingToast');
                    if (toast) {
                        toast.childNodes[1].textContent = `사진 압축 중... (${processed}/${files.length})`;
                    }
                    
                    if (processed + failed === files.length) {
                        saveData();
                        renderPhotosPage();
                        if (failed > 0) {
                            showSuccessToast(`${processed}개 추가됨 (${failed}개 실패)`);
                        } else {
                            showSuccessToast('사진이 추가되었습니다');
                        }
                    }
                }).catch(err => {
                    console.error('Image compression failed:', err);
                    failed++;
                    if (processed + failed === files.length) {
                        hideLoadingToast();
                        if (processed > 0) {
                            saveData();
                            renderPhotosPage();
                            showSuccessToast(`${processed}개 추가됨 (${failed}개 실패)`);
                        } else {
                            alert(`사진 업로드 실패: ${err.message}`);
                        }
                    }
                });
            });
        }
        
        function checkStorageSpace() {
            try {
                const data = JSON.stringify(appData);
                const used = new Blob([data]).size;
                const limit = 5 * 1024 * 1024; // 5MB
                const usedPercent = Math.round((used / limit) * 100);
                
                return {
                    hasSpace: used < limit * 0.9, // 90% limit
                    usedPercent: usedPercent,
                    usedMB: (used / (1024 * 1024)).toFixed(2),
                    limitMB: (limit / (1024 * 1024)).toFixed(2)
                };
            } catch (e) {
                return {
                    hasSpace: false,
                    usedPercent: 100,
                    usedMB: 'Unknown',
                    limitMB: '5.00'
                };
            }
        }
        
        function viewPhotoDetail(index) {
            const petPhotos = appData.photos.filter(p => p.petId === appData.currentPetId).sort((a, b) => new Date(b.date) - new Date(a.date));
            currentPhotoIndex = index;
            const photo = petPhotos[index];
            
            document.getElementById('photoDetailImage').src = photo.data;
            document.getElementById('photoDetailDate').textContent = new Date(photo.date).toLocaleDateString('ko-KR', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            document.getElementById('photoDetailMemo').textContent = photo.memo || '메모 없음';
            
            document.getElementById('photoDetailModal').classList.add('active');
        }
        
        function deletePhoto() {
            if (confirm('이 사진을 삭제하시겠습니까?')) {
                const petPhotos = appData.photos.filter(p => p.petId === appData.currentPetId).sort((a, b) => new Date(b.date) - new Date(a.date));
                const photoToDelete = petPhotos[currentPhotoIndex];
                appData.photos = appData.photos.filter(p => p.id !== photoToDelete.id);
                saveData();
                closeModal('photoDetailModal');
                renderPhotos();
            }
        }
        
        // ===== FAMILY SHARE FUNCTIONS =====
        function openFamilyShare() {
            document.getElementById('familyShareModal').classList.add('active');
            renderFamilyMembers();
        }
        
        function renderFamilyMembers() {
            const container = document.getElementById('familyMembersList');
            document.getElementById('familyMemberCount').textContent = appData.familyMembers.length;
            
            // Show limit warning for free users
            const isPremium = appData.isPremium && (!appData.premiumExpiry || new Date(appData.premiumExpiry) > new Date());
            const limitWarning = !isPremium && appData.familyMembers.length >= 2 ? `
                <div style="background: rgba(245, 158, 11, 0.15); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid rgba(245, 158, 11, 0.3);">
                    <div style="font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 8px;">
                        <span>⚠️</span>
                        <span>무료 버전은 2명까지만 가능합니다</span>
                    </div>
                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                        더 많은 가족 구성원을 초대하려면 Pro로 업그레이드하세요
                    </div>
                    <button class="add-btn" onclick="openPremiumModal()" style="width: 100%;">Pro로 업그레이드</button>
                </div>
            ` : '';
            
            container.innerHTML = limitWarning + appData.familyMembers.map(member => `
                <div class="family-member-item">
                    <div class="member-avatar">${member.avatar}</div>
                    <div class="member-info">
                        <div class="member-name">${member.name}</div>
                        <div class="member-role">${member.role}</div>
                    </div>
                    ${member.id !== 1 ? `<button class="icon-button danger" onclick="removeFamilyMember(${member.id})">🗑️</button>` : ''}
                </div>
            `).join('');
        }
        
        function copyInviteLink() {
            const isPremium = appData.isPremium && (!appData.premiumExpiry || new Date(appData.premiumExpiry) > new Date());
            
            // Check limit for free users
            if (!isPremium && appData.familyMembers.length >= 2) {
                if (confirm('무료 버전은 2명까지만 초대할 수 있습니다.\n\nPro로 업그레이드하여 무제한으로 가족을 초대하시겠습니까?')) {
                    openPremiumModal();
                }
                return;
            }
            
            const link = document.getElementById('inviteLink');
            link.select();
            document.execCommand('copy');
            alert('초대 링크가 복사되었습니다!');
        }
        
        // Simulate adding a family member when they accept invite
        function acceptInvite() {
            const isPremium = appData.isPremium && (!appData.premiumExpiry || new Date(appData.premiumExpiry) > new Date());
            
            if (!isPremium && appData.familyMembers.length >= 2) {
                alert('무료 버전은 2명까지만 가능합니다.\nPro로 업그레이드하세요!');
                openPremiumModal();
                return;
            }
            
            // Add new member (this would come from actual invite acceptance in real app)
            const newMember = {
                id: Date.now(),
                name: '가족 구성원 ' + (appData.familyMembers.length),
                role: '멤버',
                avatar: '👤'
            };
            
            appData.familyMembers.push(newMember);
            saveData();
            renderFamilyMembers();
        }
        
        function removeFamilyMember(memberId) {
            if (confirm('이 구성원을 제거하시겠습니까?')) {
                appData.familyMembers = appData.familyMembers.filter(m => m.id !== memberId);
                saveData();
                renderFamilyMembers();
            }
        }
        
        // ===== MEAL TRACKER FUNCTIONS =====
        let currentMealFilter = 'all';
        let currentMealFilterPage = 'all';
        
        // Modal version
        function openMealTracker() {
            if (!appData.currentPetId) {
                alert('먼저 반려동물을 선택해주세요!');
                return;
            }
            document.getElementById('mealTrackerModal').classList.add('active');
            updateMealSummary();
            renderMeals();
        }
        
        function updateMealSummary() {
            const today = new Date().toDateString();
            const todayMeals = appData.meals.filter(m => 
                m.petId === appData.currentPetId && 
                new Date(m.time).toDateString() === today
            );
            
            const totalCalories = todayMeals.reduce((sum, m) => sum + (parseInt(m.calories) || 0), 0);
            const totalAmount = todayMeals.reduce((sum, m) => sum + (parseInt(m.amount) || 0), 0);
            
            document.getElementById('todayMealCount').textContent = todayMeals.length;
            document.getElementById('todayCalories').textContent = totalCalories;
            document.getElementById('todayAmount').textContent = totalAmount;
        }
        
        function renderMeals() {
            const petMeals = appData.meals.filter(m => m.petId === appData.currentPetId);
            let filteredMeals = [...petMeals];
            
            // Apply filter
            const now = new Date();
            if (currentMealFilter === 'today') {
                filteredMeals = filteredMeals.filter(m => 
                    new Date(m.time).toDateString() === now.toDateString()
                );
            } else if (currentMealFilter === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredMeals = filteredMeals.filter(m => new Date(m.time) >= weekAgo);
            }
            
            const container = document.getElementById('mealsList');
            const emptyState = document.getElementById('emptyMeals');
            
            if (filteredMeals.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            emptyState.style.display = 'none';
            
            const mealIcons = {
                '사료': '🥘',
                '간식': '🦴',
                '습식': '🍖',
                '수제': '👨‍🍳'
            };
            
            container.innerHTML = filteredMeals.sort((a, b) => new Date(b.time) - new Date(a.time)).map(meal => `
                <div class="meal-item">
                    <div class="meal-icon">${mealIcons[meal.type] || '🍽️'}</div>
                    <div class="meal-info">
                        <div class="meal-name">${meal.name || meal.type}</div>
                        <div class="meal-details">
                            ${meal.amount ? meal.amount + 'g' : ''} 
                            ${meal.calories ? ' · ' + meal.calories + 'kcal' : ''}
                        </div>
                        ${meal.notes ? `<div class="meal-details" style="margin-top: 4px;">${meal.notes}</div>` : ''}
                    </div>
                    <div class="meal-time">
                        ${new Date(meal.time).toLocaleString('ko-KR', { 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit', 
                            minute: '2-digit' 
                        })}
                    </div>
                </div>
            `).join('');
        }
        
        // Page version
        function updateMealSummaryPage() {
            if (!appData.currentPetId) return;
            
            // Safety check
            if (!appData.meals) appData.meals = [];
            
            const today = new Date().toDateString();
            const todayMeals = appData.meals.filter(m => 
                m.petId === appData.currentPetId && 
                new Date(m.time).toDateString() === today
            );
            
            const totalCalories = todayMeals.reduce((sum, m) => sum + (parseInt(m.calories) || 0), 0);
            const totalAmount = todayMeals.reduce((sum, m) => sum + (parseInt(m.amount) || 0), 0);
            
            document.getElementById('todayMealCountPage').textContent = todayMeals.length;
            document.getElementById('todayCaloriesPage').textContent = totalCalories;
            document.getElementById('todayAmountPage').textContent = totalAmount;
        }
        
        function renderMealsPage() {
            if (!appData.currentPetId) {
                document.getElementById('mealsListPage').style.display = 'none';
                document.getElementById('emptyMealsPage').innerHTML = `
                    <div class="empty-state-icon">🐕</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">반려동물을 선택해주세요</div>
                    <div style="font-size: 14px;">홈 화면에서 반려동물을 선택하거나 추가하세요</div>
                `;
                document.getElementById('emptyMealsPage').style.display = 'block';
                return;
            }
            
            // Safety check
            if (!appData.meals) appData.meals = [];
            
            const petMeals = appData.meals.filter(m => m.petId === appData.currentPetId);
            let filteredMeals = [...petMeals];
            
            // Apply filter
            const now = new Date();
            if (currentMealFilterPage === 'today') {
                filteredMeals = filteredMeals.filter(m => 
                    new Date(m.time).toDateString() === now.toDateString()
                );
            } else if (currentMealFilterPage === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                filteredMeals = filteredMeals.filter(m => new Date(m.time) >= weekAgo);
            }
            
            const container = document.getElementById('mealsListPage');
            const emptyState = document.getElementById('emptyMealsPage');
            
            if (filteredMeals.length === 0) {
                container.style.display = 'none';
                emptyState.innerHTML = `
                    <div class="empty-state-icon">🍽️</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">급여 기록이 없어요</div>
                    <div style="font-size: 14px;">식사와 간식을 기록해보세요!</div>
                `;
                emptyState.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            emptyState.style.display = 'none';
            
            const mealIcons = {
                '사료': '🥘',
                '간식': '🦴',
                '습식': '🍖',
                '수제': '👨‍🍳'
            };
            
            container.innerHTML = filteredMeals.sort((a, b) => new Date(b.time) - new Date(a.time)).map(meal => `
                <div class="meal-item">
                    <div class="meal-icon">${mealIcons[meal.type] || '🍽️'}</div>
                    <div class="meal-info">
                        <div class="meal-name">${meal.name || meal.type}</div>
                        <div class="meal-details">
                            ${meal.amount ? meal.amount + 'g' : ''} 
                            ${meal.calories ? ' · ' + meal.calories + 'kcal' : ''}
                        </div>
                        ${meal.notes ? `<div class="meal-details" style="margin-top: 4px;">${meal.notes}</div>` : ''}
                    </div>
                    <div class="meal-time">
                        ${new Date(meal.time).toLocaleString('ko-KR', { 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit', 
                            minute: '2-digit' 
                        })}
                    </div>
                </div>
            `).join('');
        }
        
        function filterMeals(filter) {
            currentMealFilter = filter;
            
            // Update filter tabs
            document.querySelectorAll('#mealTrackerModal .filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderMeals();
        }
        
        function filterMealsPage(filter) {
            currentMealFilterPage = filter;
            
            // Update filter tabs
            document.querySelectorAll('#mealPage .filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderMealsPage();
        }
        
        function openAddMealModal() {
            if (!appData.currentPetId) {
                alert('먼저 반려동물을 선택해주세요!');
                return;
            }
            
            document.getElementById('addMealModal').classList.add('active');
            // Set current time
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('mealTime').value = now.toISOString().slice(0, 16);
        }
        
        function openAddMealModalPage() {
            if (!appData.currentPetId) {
                alert('먼저 반려동물을 선택해주세요!\n\n위쪽의 드롭다운에서 반려동물을 선택하세요.');
                return;
            }
            openAddMealModal();
        }
        
        // Add meal form handler
        document.getElementById('addMealForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            console.log('Form submitted!');
            console.log('Current pet ID:', appData.currentPetId);
            
            // CRITICAL: Check if pet is selected
            if (!appData.currentPetId) {
                alert('반려동물을 먼저 선택해주세요!');
                return;
            }
            
            const mealTimeValue = document.getElementById('mealTime').value;
            
            const newMeal = {
                id: Date.now(),
                petId: appData.currentPetId,
                type: document.getElementById('mealType').value,
                name: document.getElementById('mealName').value,
                amount: document.getElementById('mealAmount').value,
                calories: document.getElementById('mealCalories').value,
                time: new Date(mealTimeValue).toISOString(),
                notes: document.getElementById('mealNotes').value
            };
            
            console.log('Adding meal:', newMeal);
            
            appData.meals.push(newMeal);
            saveData();
            
            console.log('Total meals in appData:', appData.meals.length);
            console.log('Meals for current pet:', appData.meals.filter(m => m.petId === appData.currentPetId).length);
            
            // Close modal
            closeModal('addMealModal');
            
            // ALWAYS go to meal tab
            console.log('Switching to meal tab...');
            switchTab('meal');
            
            // Show success message
            showSuccessToast('식단이 기록되었습니다');
            
            e.target.reset();
        });
    </script>
    <!-- ChannelTalk -->
    <script>
        // ChannelTalk 설치 가이드
        // 1. https://channel.io 가입
        // 2. 플러그인 키 발급
        // 3. 아래 YOUR_PLUGIN_KEY를 실제 키로 교체
        
        /*
        (function(){
            var w=window;
            if(w.ChannelIO){return w.console.error("ChannelIO script included twice.");}
            var ch=function(){ch.c(arguments);};
            ch.q=[];
            ch.c=function(args){ch.q.push(args);};
            w.ChannelIO=ch;
            function l(){
                if(w.ChannelIOInitialized){return;}
                w.ChannelIOInitialized=true;
                var s=document.createElement("script");
                s.type="text/javascript";
                s.async=true;
                s.src="https://cdn.channel.io/plugin/ch-plugin-web.js";
                var x=document.getElementsByTagName("script")[0];
                if(x.parentNode){x.parentNode.insertBefore(s,x);}
            }
            if(document.readyState==="complete"){l();}
            else{w.addEventListener("DOMContentLoaded",l);w.addEventListener("load",l);}
        })();
        
        ChannelIO('boot', {
            "pluginKey": "YOUR_PLUGIN_KEY", // 여기에 실제 플러그인 키 입력
            "memberId": null,
            "profile": {
                "name": null,
                "mobileNumber": null,
                "email": null
            }
        });
        */
    </script>
    
    <script>
    // RevenueCat 초기화
    document.addEventListener('DOMContentLoaded', async () => {
  const isNative = typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform();
  
  if (isNative) {
    console.log('네이티브 앱 모드');
    
    try {
      const { Purchases } = await import('@revenuecat/purchases-capacitor');
      
      await Purchases.configure({
        apiKey: 'test_NgAURldjsDJanjHrYYXZnSjcCqj'  // 아까 복사한 API 키!
      });
      
      console.log('RevenueCat 초기화 완료');
      
      // 구독 상태 확인
      const customerInfo = await Purchases.getCustomerInfo();
      if (customerInfo.entitlements.active['pro']) {
        appData.isPremium = true;
        saveData();
        console.log('Pro 구독 활성화됨');
      }
    } catch (error) {
      console.error('RevenueCat 초기화 실패:', error);
    }
  }
});

// 프리미엄 구매 함수 수정
const originalUpgrade = window.upgradeToPremium;

window.upgradeToPremium = async function(period) {
  const isNative = typeof Capacitor !== 'undefined' && Capacitor.isNativePlatform();
  
  if (isNative) {
    // 네이티브 앱: RevenueCat 결제
    try {
      const { Purchases } = await import('@revenuecat/purchases-capacitor');
      
      showSuccessToast('결제 진행 중...');
      
      const offerings = await Purchases.getOfferings();
      const monthly = offerings.current?.monthly;
      
      if (!monthly) {
        alert('상품을 불러올 수 없습니다.');
        return;
      }
      
      const purchase = await Purchases.purchasePackage({ 
        aPackage: monthly 
      });
      
      if (purchase.customerInfo.entitlements.active['pro']) {
        appData.isPremium = true;
        saveData();
        
        showSuccessToast('🎉 Pro 구독이 활성화되었습니다!');
        closeModal('premiumModal');
        checkPremiumStatus();
      }
    } catch (error) {
      if (!error.userCancelled) {
        console.error('결제 오류:', error);
        alert('결제 중 오류가 발생했습니다.');
      }
    }
  } else {
    // 웹앱: 기존 데모
    originalUpgrade(period);
  }
};
</script>
</body>
</html>